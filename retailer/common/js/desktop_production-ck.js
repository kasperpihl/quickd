/*********************************************** 
     Begin function.js 
***********************************************/function timeAgo(a){var b=new Date(a),c=((new Date).getTime()-b.getTime())/1e3,d=Math.floor(c/86400);if(isNaN(d)||d<0)return;return d==0&&(c<120&&"Lige nu"||c<3600&&Math.floor(c/60)+" minutter siden"||c<7200&&"1 time siden"||c<86400&&Math.floor(c/3600)+" timer siden")||d==1&&"Igår"||d<7&&d+" dage siden"||d<10&&"Omkring en uge siden"||d<17&&"Omkring to uger siden"||d<28&&Math.ceil(d/7)+" uger siden"||d>28&&"Over 1 måned siden"}function hasOwnProperty(a,b){var c=a.__proto__||a.constructor.prototype;return b in a&&(!(b in c)||c[b]!==a[b])}function calcDiscount(a,b,c){if(c)var d=$(c);var e=$(c+"-input");if(!a||!b||isNaN(a)||isNaN(b)){if(!d)return"-";d.html("-");e&&e.val(0);d.addClass("badValue")}else{var f=Math.floor((a-b)/a*100);if(!d)return f;d.html(f+"%");e&&e.val(f);if(f<=0){d.html("-");d.addClass("badValue")}else f<20||f>100?d.addClass("badValue"):d.removeClass("badValue")}}function stampToTime(a){var b=new Date(a*1e3),c=b.getHours(),d=b.getMinutes(),e=b.getSeconds(),f=c+":"+d+":"+e;return f}function padNumber(a){a||(a=0);a<10&&(a="0"+a);return a}function getTimeString(a,b,c){if(a)var d=new Date(a);else var d=new Date;var e=d.getDate(),f=d.getMonth()+1,g=d.getFullYear();if(c)var h=Math.ceil(d.getMinutes()/c)*c,i=padNumber(h%60),j=padNumber((d.getHours()+Math.floor(h/60))%24);else var i=padNumber(d.getMinutes()),j=padNumber(d.getHours());if(b&&b=="simple"){if(d.toDateString()==Date.today().toDateString())var k="I dag";else if(d.toDateString()==Date.parse("yesterday").toDateString())var k="I går";else var k=e+"/"+f+" "+g;k=k+", kl. "+j+":"+i;return k}if(b){f=padNumber(f);e=padNumber(e);return e+"-"+f+"-"+g+" "+j+":"+i}return f+"-"+e+"-"+g+" "+j+":"+i}function dateToAmr(a,b){if(!b)var b=["dd-MM-yyyy HH:mm","dd-MM-yyyy "];if(a)return Date.parseExact(a,b)}function convertNumber(a,b){if(b){a=parseFloat(a);a=""+a.toFixed(2);return a.replace(".",",")}return parseFloat(a.replace(",",".").replace(" ",""))}function convertToTimestring(a){var b=a.split(":"),c=padNumber(parseInt(b[0])),d=padNumber(parseInt(b[1]));return c+":"+d}function resizeBg(a){var b=$("#bgImage"),c=$("#content"),d=c.width(),e=c.height(),f=b.width(),g=b.height();f/d<g/e?e=d*g/f:d=e*f/g;b.css({width:d+"px",height:e+"px"});if(!a){b.fadeIn(500);$(window).resize(function(){resizeBg(!0)})}}var loadedTemplates={};window.log=function(){log.history=log.history||[];log.history.push(arguments);if(this.console){arguments.callee=arguments.callee.caller;var a=[].slice.call(arguments);typeof console.log=="object"?log.apply.call(console.log,console,a):console.log.apply(console,a)}};(function(a){function b(){}for(var c="assert,count,debug,dir,dirxml,error,exception,group,groupCollapsed,groupEnd,info,log,timeStamp,profile,profileEnd,time,timeEnd,trace,warn".split(","),d;d=c.pop();)a[d]=a[d]||b})(function(){try{console.log();return window.console}catch(a){return window.console={}}}());X={};X.input={};X.input.iblur=function(){var a=jQuery(this).attr("value"),b=jQuery(this).attr("xtip");if(a==b||!a){jQuery(this).attr("value",b);jQuery(this).css("color","#999")}};X.input.iclick=function(){var a=jQuery(this).attr("value"),b=jQuery(this).attr("xtip");a==b&&jQuery(this).attr("value","");jQuery(this).css("color","#333")};X.input.hideLabel=function(){var a=$(this),b=a.val(),c=a.prev(".label");b||b!=""?c.hide(100):c.show(100)};X.input.optionalLabel=function(){var a=$(this),b=a.val(),c=a.prev(".label");if(b||b!=""){a.removeClass("optional");c.removeClass("optional")}else{a.addClass("optional");c.addClass("optional")}};String.prototype.trunc=function(a,b){var c=this.length>a,d=c?this.substr(0,a-1):this;d=b&&c?d.substr(0,d.lastIndexOf(" ")):d;return c?d+"…":d};Object.size=function(a){var b=0,c;for(c in a)a.hasOwnProperty(c)&&b++;return b};$(function(){$.fn.centerBox=function(){var a=$(this),b=a.width(),c=a.height(),d=$(document).width(),e=$(document).height(),f=d/2-b/2,g=e/2-c/2;a.css({position:"absolute",left:f,top:g});return a};$.fn.shakeBox=function(a){var b=$(this),c=b.position().left,d=50,e=30;for(i=5;i>=1;i--){var f=c-i*2,g=i==1?c:c+i*2;b.animate({left:f},{duration:d}).animate({left:g},{duration:d})}a?b.find("input").filter(":last").val("").focus():b.find("input").filter(":last").focus().select();return b};$.fn.hiddenHeight=function(){var a=$(this),b=0;if(!a.is(":visible")){var c=a.css("position"),d=a.css("display");a.css({position:"absolute",visibility:"hidden",display:"block"});b=a.height();a.css({visibility:"visible",position:c,display:d})}else b=a.outerHeight();return b};$.fn.verticalAlign=function(a,b){var c=$(this),d=c.parent();if(b&&b.meHeight)var e=b.meHeight;else var e=c.outerHeight();var f=d.outerHeight(),g=Math.round(f/2-e/2);b&&b.offset&&(g+=b.offset);b&&b.animate&&c.is(":visible")?c.css({position:"absolute",top:c.position().top}).animate({top:g},{duration:1e3,easing:"easeOutExpo",queue:!1}):c.css({position:"absolute",top:g});a||$(window).resize(function(){c.is(":visible")&&c.verticalAlign(!0)});return c};$.fn.formValidate=function(a){var b=$(this);b.addClass("validating");if(!a)var a={};b.find("textarea, input").each(function(){var c=$(this);a.submitKey&&c.is("input")&&c.attr("type")!="button"&&c.keypress(function(d){if(d.keyCode==13){c.blur();b.find(a.submitKey).click()}});if(c.attr("hideLabel")){c.wrap('<div class="input-wrapper" />');c.before("<div class='label hider'>"+c.attr("hideLabel")+"</div>");c.addClass("wrapped");c.focus(function(){c.parent(".input-wrapper").addClass("focus")});c.blur(function(){c.parent(".input-wrapper").removeClass("focus")});c.keyup(X.input.hideLabel)}if(c.attr("title")){if(a.tooltipOffset)var d=a.tooltipOffset;else var d=c.position().left+15;if(a.tooltipPosition)var e=a.tooltipPosition;else var e="center left";c.tooltip({position:e,predelay:100,offset:[0,-d],effect:"fade",opacity:.7})}});a.errorClass||(a.errorClass="errorTip");a.errorElement||(a.errorElement="div");a.errorPlacement||(a.errorPlacement=function(a,b){var c=b.parents(".field");c?a.appendTo(c):a.insertAfter(b)});b.is("form")?b.validate(a):b.find("form").each(function(){$(this).validate(a)});return b};$.fn.formSetState=function(a,b){var c=$(this),d=c.find(".edit-save-button").filter(":first");if(a=="readonly"&&b){d.wrap('<div class="loader-small" />');setTimeout(function(){d.unwrap();d.val("Rediger");c.find("input[type=text], input[type=password], textarea, .category").each(function(){$(this).attr("readonly",1).addClass("readonly")})},500)}else if(a=="readonly"){c.find("input[type=text], input[type=password], textarea, .category").each(function(){$(this).attr("readonly",1).addClass("readonly")});d.val("Rediger")}else if(a=="edit"){c.find("input[type=text], input[type=password], textarea, .category").each(function(){$(this).removeAttr("readonly").removeClass("readonly")});d.val("Gem")}return c};$.fn.createMask=function(a,b){var c=$(this);if(!b)var b="";else b=" "+b;if(c.attr("id"))var d=c.attr("id")+"-mask";else var d=c.get(0).tagName+"-mask";c.css("position")=="static"&&c.css("position","relative");if(c.is("body")){var e=$('<div class="body-mask'+b+'" id="'+d+'"></div>').hide().appendTo("body");e.css({position:"absolute",width:$(document).width(),height:$(document).height()})}else if(c.hasClass("window-container")){var e=$('<div class="window-mask'+b+'" id="'+d+'"></div>').hide();c.css({position:"relative"}).addClass("inactive").append(e);e.css({position:"absolute",top:-5,left:-5,bottom:-5,right:-5})}else{var e=$('<div class="body-mask'+b+'" id="'+d+'"></div>').hide().css({position:"absolute",top:0,bottom:0,left:0,right:0});c.append(e)}e.css({display:"block",opacity:0});e.animate({opacity:.7},400,function(){a&&$(this).click(a)});return c};$.fn.removeMask=function(a,b){var c=$(this),d;if(c.attr("id"))var e=c.attr("id")+"-mask";else var e=c.get(0).tagName+"-mask";d=c.find("#"+e);a?d.fadeOut(a,function(){d.remove();b&&b()}):d.remove();c.is("body")||c.removeClass("inactive");return c};$.validator.addMethod("saving",function(){var a=convertNumber($("#orig_price").val()),b=convertNumber($("#deal_price").val());if(a&&b)var c=calcDiscount(a,b);var d=a&&b&&(isNaN(c)||c<20);return!d},"Den valgte besparelse er ikke tilstrækkelig stor");$.validator.addMethod("danishNumber",function(a,b){var c=convertNumber(a,!1);return!isNaN(c)&&c>0},"Det indtastede er ikke et korrekt tal");$.extend($.validator.messages,{required:"Du mangler at udfylde dette felt",email:"Du skal indtaste en e-mail her",digits:"Du kan kun indtaste tal",number:"Du skal indtaste et tal her",url:"Du skal indtaste en gyldig hjemmeside",minlength:jQuery.format("Du skal indtaste mindst {0} tegn!"),equalTo:"Indtast venligst det samme i begge felter"});$.fn.outerHTML=function(a){return a?this.before(a).remove():$("<p>").append(this.eq(0).clone()).html()};$.fn.getHiddenDimensions=function(a){var b=this,c={position:"absolute",visibility:"hidden",display:"block"},d={width:0,height:0,innerWidth:0,innerHeight:0,outerWidth:0,outerHeight:0},e=b.is(":visible")?$([]):b.parents().andSelf().not(":visible"),a=a==null?!1:a,f=[];e.each(function(){var a={};for(var b in c){a[b]=this.style[b];this.style[b]=c[b]}f.push(a)});d.width=b.width();d.outerWidth=b.outerWidth(a);d.innerWidth=b.innerWidth();d.height=b.height();d.innerHeight=b.innerHeight();d.outerHeight=b.outerHeight(a);e.each(function(a){var b=f[a];for(var d in c)this.style[d]=b[d]});return d}});App.collections.Deals=Backbone.Collection.extend({url:ROOT_URL+"api/shopowner/deals",parse:function(a){return a.data},comparator:function(a){return a.get("start")},isStartedDeal:function(a){var b=parseInt((new Date).getTime()/1e3,10),c=this.filter(function(c){return a!=c.get("template_id")?!1:c.get("start")>b?!1:c.get("end")<b?!1:!0});return c.length>0?c[0]:!1},model:App.models.Deal});App.collections.Images=Backbone.Collection.extend({url:ROOT_URL+"api/shopowner/images",parse:function(a){return a.results},comparator:function(a){return-parseInt(a.get("id"),10)},getUrl:function(a,b){var c=IMG_URL+b+"/noimage.png";if(!a)return c;b||(b="thumbnail");var d=this.get(a);return d?d.getUrl(b):c},model:App.models.Image});App.collections.Feedback=Backbone.Collection.extend({url:ROOT_URL+"api/shopowner/feedback",parse:function(a){return a.data},model:App.models.Image});App.collections.Shops=Backbone.Collection.extend({url:ROOT_URL+"api/shopowner/shops",parse:function(a){return a.data},model:App.models.Shop});App.collections.Templates=Backbone.Collection.extend({url:ROOT_URL+"api/shopowner/templates",parse:function(a){return a.data},comparator:function(a){return-a.get("created_at")},getApproved:function(){var a=[];this.each(function(b){b.get("approved")==="approved"&&a.push(b.toJSON())});return a},model:App.models.Template});App.models.Deal=Backbone.Model.extend({urlRoot:ROOT_URL+"api/shopowner/deals",initialize:function(a){this.setState()},parse:function(a){a.success=="true"&&a.data&&this.setState(a.data.start,a.data.end);return a.data},getCountdown:function(){var a=parseInt((new Date).getTime()/1e3,10),b=parseInt(this.get("end"),10);return b-a},isStarted:function(){var a=this.get("start"),b=this.get("end");if(a&&b){var c=(new Date).getTime()/1e3;return b<c?!1:a>c?!1:!0}return!1},setState:function(a,b){a||(a=this.get("start"));b||(b=this.get("end"));if(a&&b){var c=(new Date).getTime()/1e3;b<c?this.set({state:"ended"},{silent:!0}):a<c?this.set({state:"current"},{silent:!0}):this.set({state:"planned"},{silent:!0});var d=0;this.get("state")=="planned"?d=Math.round(a-c):this.get("state")=="current"&&(d=Math.round(b-c));if(d>0){var e=this;setTimeout(function(){if(e.get("state")=="planned"){e.set("state","current");c=(new Date).getTime()/1e3;setTimeout(function(){e.set("state","ended")},(e.get("end")-c)*1e3)}else e.get("state")=="current"&&e.set("state","ended")},d*1e3)}}}});App.models.Image=Backbone.Model.extend({urlRoot:ROOT_URL+"api/shopowner/images",parse:function(a){return a.data},rotate:function(a,b){var c=this;$.get(ROOT_URL+"ajax/image.php",{action:"rotate",direction:a,index:this.get("id")},function(a){if(a.success=="true")c.set(a.data);else{log("error rotating",a.error);switch(a.error){}}},"json")},editThumb:function(a){log(a)},getUrl:function(a){return IMG_URL+a+"/"+this.get("n")+"?"+this.get("rev")}});App.models.Feedback=Backbone.Model.extend({urlRoot:ROOT_URL+"api/shopowner/feedback",parse:function(a){return a.data}});App.models.Shop=Backbone.Model.extend({urlRoot:ROOT_URL+"api/shopowner/shops",parse:function(a){return a.data}});App.models.Shopowner=Backbone.Model.extend({url:ROOT_URL+"api/shopowner",getNotifications:function(){},parse:function(a){return a}});App.models.Template=Backbone.Model.extend({urlRoot:ROOT_URL+"api/shopowner/templates",parse:function(a){return a.data},isApproved:function(){return this.get("approved")=="approved"}});define(["common/collections/collections","common/models/models","views/dashboard","views/dialogs/promtDialog"],function(){App.routers.Dashboard=Backbone.Router.extend({routes:{oversigt:"openOverview","oversigt/:path":"openOverview","oversigt/:path/:id":"openOverview",skabeloner:"openTemplates","skabeloner/:path":"openTemplates",administration:"openAdministration","administration/:path":"openAdministration",start:"openStartDeals","start/:id":"openStartDeals",hjem:"openHomeView","*index":"indexing"},start:function(a){this.route;!App.models.shopowner&&shopowner&&(App.models.shopowner=new App.models.Shopowner(shopowner.dealer));_.bindAll(this,"getChanges","changes","retryConnection");App.collections.feedback=new App.collections.Feedback;App.collections.templates=new App.collections.Templates;App.collections.shops=new App.collections.Shops;App.collections.deals=new App.collections.Deals;App.collections.images=new App.collections.Images;a.stuff&&this.setStuff(a.stuff);App.views.dashboard=new App.views.Dashboard({router:this});this.errorCount=0;this.networkErrorDialog=new App.views.dialogs.PromtDialog({router:this,type:"promt",callbackCid:"dashboard-router",openOnCreate:!1,closable:!1,destroyOnClose:!1,title:"Ingen forbindelse til serveren",msg:"Vi kan i øjeblikket ikke få forbindelse til vores server. Tjek din internetforbindelse og prøv ingen",confirmText:"Prøv igen"});this.bind("promtCallback:dashboard-router",this.retryConnection);this.getChanges();this.on("route:*index",this.indexing);this.started=!0},indexing:function(){log("indexing");this.started&&this.navigate("hjem",{trigger:!0})},openHomeView:function(){App.views.dashboard.changeActivity({activity:"welcome"})},openStartDeals:function(a){var b={activity:"startdeals",route:lang.urls.startdeals,isRouted:!0};if(a){b.route=lang.urls.startdeals+"/"+a;b.window="startWithTemplate";b.id=a}else b.isParentRoute=!0;App.views.dashboard.changeActivity(b)},openTemplates:function(a){var b={activity:"templates",route:lang.urls.templates,isRouted:!0};a&&(b.route=lang.urls.templates+"/"+a);if(a=="tilfoej")b.window="addTemplate";else if(a){b.window="viewTemplate";b.id=a}else b.isParentRoute=!0;App.views.dashboard.changeActivity(b)},openOverview:function(a,b){var c={activity:"overview",route:lang.urls.overview,isRouted:!0};if(a){c.route=lang.urls.overview+"/"+a;c.window=a}else c.isParentRoute=!0;if(b){c.id=b;c.route+="/"+b}App.views.dashboard.changeActivity(c)},openAdministration:function(a){var b={activity:"administration",route:lang.urls.administration,isRouted:!0};if(a){b.route=lang.urls.administration+"/"+a;b.window=a}else b.isParentRoute=!0;App.views.dashboard.changeActivity(b)},showError:function(a,b){a=a?a:"Der op stod en fejl";b=b?b:"";if(!this.errorDialog)this.errorDialog=new App.views.dialogs.PromtDialog({router:this,type:"promt",callbackCid:"error-msg-promt",openOnCreate:!0,closable:!0,destroyOnClose:!1,classes:"error-promt",title:a,msg:b,confirmText:"Okay"});else{this.errorDialog.setText(a,b);this.errorDialog.openDialog()}},retryConnection:function(a){this.networkErrorShown&&(this.networkErrorShown=!1);this.getChanges(!0,!0)},getChanges:function(a){var b=this,c=localStorage.getItem("cindex")!="undefined"?localStorage.getItem("cindex"):0,d=localStorage.getItem("csince")!="undefined"?localStorage.getItem("csince"):0,e=function(){if(b.errorCount>=1&&b.networkErrorDialog&&!b.networkErrorShown){b.networkErrorDialog.openDialog();b.networkErrorShown=!0}b.errorCount++};$.ajax({type:"GET",url:ROOT_URL+"ajax/changes.php",data:"cindex="+c+"&csince="+d,async:!0,cache:!1,timeout:5e3,success:function(c){c=$.parseJSON(c);c.hasOwnProperty("success")&&c.success=="false"&&c.error=="error_database"?e():b.changes(c);a||setTimeout(b.getChanges,3e3)},error:function(c,d,f){log("Error changes",c,d,f);e();a||setTimeout(b.getChanges,3e3)}},"json")},setStuff:function(a){_.each(a,function(a,b){var c=a.value;if(c.hasOwnProperty("type")&&c.type=="deal"){var d=new App.models.Deal(c);App.collections.deals.add(d)}c.hasOwnProperty("historySince")&&localStorage.setItem("cindex",parseInt(c.historySince));c.hasOwnProperty("images")&&_.each(c.images,function(a,b){var c=new App.models.Image(a);App.collections.images.add(c)});c.hasOwnProperty("shops")&&_.each(c.shops,function(a,b){var c=new App.models.Shop(a);App.collections.shops.add(c)});c.hasOwnProperty("templates")&&_.each(c.templates,function(a,b){var c=new App.models.Template(a);App.collections.templates.add(c)});c.hasOwnProperty("feedback")&&_.each(c.feedback,function(a,b){var c=new App.models.Feedback(a);App.collections.feedback.add(c)})})},changes:function(a){this.networkErrorShown&&this.networkErrorDialog.closeDialog();this.errorCount=0;if(a.hasOwnProperty("success")&&a.success=="false")return;a.hasOwnProperty("csince")&&localStorage.setItem("csince",a.csince);a.hasOwnProperty("cindex")&&localStorage.setItem("cindex",a.cindex);if(!a.data)return;var b=a.data;if(b.length>0){var c={};for(var d=b.length-1;d>=0;d--){var e=b[d].value,f,g,h,i;switch(e.type){case"template":i=lang.urls.templates+"/"+e.id;g=App.models.Template;h=App.collections.templates;f=h.get(e.id);break;case"shop":i=lang.urls.administrationShop;g=App.models.Shop;h=App.collections.shops;f=h.get(e.id);break;case"feedback":i=lang.urls.overviewFeedback+"/"+e.id;e.hasOwnProperty("hours")&&parseInt(e.hours)>0&&App.models.shopowner.fetch();g=App.models.Feedback;h=App.collections.feedback;f=h.get(e.id);break;case"deal":i=lang.urls.overviewDeals+"/"+e.id;g=App.models.Deal;h=App.collections.deals;f=h.get(e.id);break;default:continue}if(f&&e.rev>f.get("rev")){f.fetch({success:function(a,b){log("response fra fetch1",a,b)},error:function(a,b){log(a,b)}});App.views.notifications.changesHandling(e,i)}if(f===undefined){log("fetchedU",e.type,e.id);f=new g({id:e.id});f.fetch({success:function(a,b){log("response fra fetch2",a,b);if(b.success=="true"){h.add(a);App.views.notifications.changesHandling(e,i)}},error:function(a,b){log(a,b)}})}}}},templates:function(){},deals:function(){}})});define(["order!views/dialogs/dialog","order!views/entry","common/models/models","routers/dashboard"],function(){App.routers.Entry=Backbone.Router.extend({routes:{login:"setViewLogin",register:"setViewRegister","*index":"setViewLogin"},initialize:function(){this.route=!1;this.entryView=new App.views.Entry({router:this});this.model=App.models.shopowner=new App.models.Shopowner;this.view="login";this.box=!1;_.bindAll(this,"doLogin","doRegister","openRegisterView","closeRegisterView")},setViewLogin:function(a){if(this.isLoggedIn)return!1;this.view="login";this.entryView.created&&this.closeRegisterView()},setViewRegister:function(a){if(this.isLoggedIn)return!1;this.view="register";this.entryView.created&&this.openRegisterView()},animateDashboard:function(){$("#body-mask").hide();$("#header-login").animate({top:"-700px",opacity:1},500,"easeInQuart");$("#footer-login").animate({bottom:"-700px",opacity:1},500,"easeInQuart")},animateDoRegister:function(){$("#header-login").animate({height:$(window).height()/2+"px",opacity:1},1200,"easeOutQuart");$("#position_wrapper").animate({marginTop:"-124px"},1200,"easeOutQuart")},doLogin:function(){if(this.lockAction)return!1;this.lockAction=!0;var a=this,b={stuff:!0,email:$("#login_username").val(),password:$("#login_password").val()};$("#stay_signed_in_check:checked").length>0&&(b.remember=!0);$.post(ROOT_URL+"api/login",b,function(b){if(b.success=="true"){a.animateDashboard();a.lockAction=!1;setTimeout(function(){a.model.set(b.dealer);a.startDashboard(b.stuff)},200)}else{a.entryView.shakeDialog();setTimeout(function(){a.lockAction=!1},400)}},"json")},doRegister:function(){if(this.lockAction)return!1;this.lockAction=!0;var a=this;$.post(ROOT_URL+"api/register",{email:$("#register_username").val(),password:$("#register_password").val(),betacode:$("#register_betacode").val()},function(b){if(b.success=="true"){$("#footer-login").fadeOut();$("#header-login").fadeOut();setTimeout(function(){a.lockAction=!1;a.model.set(b.data);a.startDashboard()},200)}else{setTimeout(function(){a.lockAction=!1},400);var c=$("#error_container");b.error=="user_exists"?c.html("Brugeren findes allerede"):b.error=="wrong_betacode"?c.html("Betanøglen er ugyldig"):b.error=="email_not_valid"?c.html("Den indtastede email er ugyldig"):b.error=="password_must_be_6_long"&&c.html("Det valgte password er for kort");c.show()}},"json")},doResetPass:function(a){if(this.lockAction)return!1;this.lockAction=!0;var b=this;$.post(ROOT_URL+"api/reset",{model:{email:a,type:"dealer"}},function(a){if(a.success=="true"){b.resetPassView&&b.resetPassView.success();b.lockAction=!1}else{b.resetPassView&&b.resetPassView.error();setTimeout(function(){b.lockAction=!1},400)}},"json")},openRegisterView:function(){var a=$("#entry_view");$("#header-login").animate({height:a.outerHeight()+"px",opacity:1},1200,"easeOutQuart",function(){$("#header-login").height("100%")});$("#position_wrapper").animate({marginTop:"-210px"},1200,"easeOutQuart");$("#login_fields").animate({left:"-50%"},400,"easeInQuart",function(){$(this).hide();$("#registrer").css("display","block");$("#registrer").animate({right:"50%",marginRight:"-224px"},400,"easeOutQuart",function(){$("#register_username").focus()})});this.navigate("register")},closeRegisterView:function(){var a=$("#entry_view");$("#header-login").animate({height:a.outerHeight()/2+"px",opacity:1},1200,"easeOutQuart",function(){$("#header-login").height("50%")});$("#position_wrapper").animate({marginTop:"-124px"},1200,"easeOutQuart");$("#registrer").animate({right:"-50%",marginRight:"-203px"},400,"easeInQuart",function(){$("#login_fields").show().animate({left:"50%"},400,"easeOutQuart");$("#registrer").css("display","none");$("#login_username").focus()});this.navigate("login")},openConditionsView:function(){var a=this;require(["views/dialogs/conditions"],function(){a.conditionsView=new App.views.dialogs.Conditions({router:a});a.conditionsView.openDialog()})},openResetPass:function(a){var b=this;require(["views/dialogs/resetPassword"],function(){b.resetPassView=new App.views.dialogs.ResetPassword({router:b,email:a});b.resetPassView.openDialog()})},startDashboard:function(a){var b={};a&&(b.stuff=a);this.isLoggedIn=!0;App.routers.dashboard=new App.routers.Dashboard;App.routers.dashboard.start(b);$("#footer.entry_footer").remove();$(function(){App.routers.dashboard.navigate("hjem",{trigger:!0})})}});return App.routers.Entry});define(["views/dialogs/dialog"],function(){App.views.dialogs.Refill=App.views.Dialog.extend({el:"#content",initialize:function(){var a=this;this.template="refill";this.router=this.options.router;this.width=500;this.closable=!0;this.init(this.options);this.createDialog();_.bindAll(this,"handleClick")},events:{"click #btn_accept":"handleClick"},handleClick:function(){this.closeDialog(!0)}})});define(["views/dialogs/dialog"],function(){App.views.dialogs.PromtDialog=App.views.Dialog.extend({el:"#content",initialize:function(){var a=this;this.init(this.options);this.type=this.options.type;this.type=="confirmClose"?this.template="promtConfirmClose":this.type=="confirm"?this.template="promtConfirm":this.template="promt";this.title=this.options.title;this.msg=this.options.msg;this.confirmText=this.options.confirmText;this.cancelText=this.options.cancelText;this.router=this.options.router;this.width=300;this.height=100;this.aniTime=200;this.openOnCreate=this.options.hasOwnProperty("openOnCreate")?this.options.openOnCreate:!0;this.closable=this.options.hasOwnProperty("closable")?this.options.closable:!0;this.destroyOnClose=this.options.hasOwnProperty("destroyOnClose")?this.options.destroyOnClose:!0;this.callbackCid=this.options.callbackCid;this.windowName=this.options.windowName;this.createDialog(this);_.bindAll(this,"handleClick")},events:{"click #btn_confirm, #btn_dont_save, #btn_cancel":"handleClick"},handleClick:function(a){if(!this.closing){this.closing=!0;var b=a.currentTarget.id,c=b.substr(4);this.closeDialog(this.destroyOnClose,!0);this.doTrigger(c)}return!1},onOpen:function(){this.closing=!1},onClose:function(){this.doTrigger("cancel")},doTrigger:function(a){this.router.trigger("promtCallback:"+this.callbackCid,{eventType:a,callbackCid:this.callbackCid,type:this.type,windowName:this.windowName})},setText:function(a,b){$(this.dialog).find("h1").html(a).end().find(".msg").html(b)}})});define(["views/windows/window"],function(){App.views.windows.Overview=App.views.Window.extend({el:"#activity_overview",template:"overview",width:300,initialize:function(){this.template="overview";this.init();this.createWindow(!0)},events:{"click #btn_view_feedback":"viewFeedback","click #btn_view_deals":"viewDeals"},render:function(){},viewDeals:function(a){this.router.navigate(lang.urls.overviewDeals,{trigger:!0})},viewFeedback:function(a){this.router.navigate(lang.urls.overviewFeedback,{trigger:!0})}})});define(["views/windows/window","views/dialogs/imageSelector","views/dialogs/promtDialog"],function(){App.views.windows.ViewTemplate=App.views.Window.extend({el:"#activity_templates",initialize:function(){this.init(this.options);_.bindAll(this,"editTemplate","delTemplate","confirmCallback","startDeal","setValidator","events","cancelEdit","openSelectImage","imageSelected","updateContent");this.template="viewtemplate";this.depth=2;this.confirmClose=!0;this.model=this.options.model;var a={model:this.model.attributes};this.state="view";a.model.image&&(this.imageWasSelected=!0);this.createWindow(!0,a);this.router.bind("imageSelected",this.imageSelected);App.collections.templates.bind("change",this.updateContent);this.router.bind("promtCallback:"+this.cid,this.confirmCallback)},events:function(){var a={},b="#window-"+this.cid;a["click "+b+" #btn_edit_template"]="editTemplate";a["click "+b+" #btn_start_deal_template"]="startDeal";a["click "+b+" #btn_cancel_template"]="cancelEdit";a["click "+b+" input:not(:button).readonly, textarea.readonly"]="editTemplate";a["click "+b+" #btn_select_image, "+b+" #image-field"]="openSelectImage";a["click "+b+" #btn_del_template"]="delTemplate";a["keyup "+b+" #deal_price, "+b+" #orig_price"]="priceChanged";a["click "+b+" .category"]="categoryChanged";return a},updateContent:function(a,b){if(a!=this.model)return;if(this.state!="view")return;this.setContent({model:a.attributes})},setValidator:function(){var a=this;this.form||(this.form=$(this.windowId).find("form:not(.validating)"));if(this.form){this.form.formValidate({submitKey:"#btn_edit_template",rules:{title:{required:!0,minlength:5},description:{required:!0,minlength:5},orig_price:{required:!0,danishNumber:!0,saving:!0},deal_price:{required:!0,danishNumber:!0,saving:!0}},errorPlacement:function(a,b){if(b.attr("name")=="orig_price"||b.attr("name")=="deal_price")$("#prices-error").html(a);else{var c=b.parents(".field");c?a.appendTo(c):a.insertAfter(b)}}});$(this.form).find("input, textarea").focus(function(){a.lastFocus=$(this)})}},editTemplate:function(a){if(this.state=="view"){$("#btn_edit_template").html("Gem").addClass("blue");$("#btn_cancel_template").css("display","block");$("#btn_del_template").css("display","block");$(this.windowId).formSetState("edit").find("#categories").addClass("edit");this.state="edit";this.form||this.setValidator();if($("#"+a.currentTarget.id).is(":button"))this.lastFocus?this.lastFocus.focus():this.form.find("input[type=text]:first").focus();else{a.currentTarget.blur();a.currentTarget.focus()}this.important=!0;this.router.trigger("lock",{lock:"window",me:this.cid,activityCid:this.activity.cid,depth:this.depth})}else{var b={};$("#img_src").val()!=""&&$("#img_src").val()!=this.model.attributes.image&&(b.image=$("#img_src").val());$(this.windowId+" .category.selected")&&(b.category=$(this.windowId+" .category.selected").attr("id").substr(4));var c=this;this.saveToModel({onChanged:function(){c.router.trigger("templateEdited",{event:"templateEdited"})},success:function(a,b){$("#btn_edit_template").html("Rediger").removeClass("blue");$("#btn_cancel_template").css("display","none");$("#btn_del_template").css("display","none");$(c.windowId).find("#categories").removeClass("edit");c.state="view"},error:function(a,b){log("error saving model",a,b)}},!1,b);this.important=!1;this.lastFocus=!1}return!1},startDeal:function(){log(this.model.get("approved"));if(this.model.get("approved")=="approved"){var a=lang.urls.startdeals+"/"+this.model.get("id");this.router.navigate(a,{trigger:!0})}return!1},cancelEdit:function(){var a={model:this.model.attributes};this.state="view";this.setContent(a);this.router.trigger("unlock",{lock:"window",activityCid:this.activity.cid,depth:this.depth});return!1},priceChanged:function(){this.form&&this.form.valid();var a=$("#orig_price").val(),b=$("#deal_price").val();calcDiscount(a,b,"#discount-field")},delTemplate:function(){var a=new App.views.dialogs.PromtDialog({router:this.router,type:"confirm",callbackCid:this.cid,title:"Er du sikker på, du ønsker at slette denne skabelon?",confirmText:"Slet"});return!1},confirmCallback:function(a){var b=this;if(a.callbackCid==this.cid&&a.type=="confirm")if(a.eventType=="confirm"){this.model.destroy({data:this.model.id,success:function(a,c){log("deleted",a,c);b.router.trigger("templateEdited",{event:"templateDeleted"})},error:function(a,b){log("error delete: ",a,b)}});this.activity.closeWindow(this,!1,!0)}else this.router.trigger("setFocus",{activity:this.activity,windowCid:this.cid})},openSelectImage:function(){this.selectorView||(this.selectorView=new App.views.dialogs.ImageSelectorView({router:this.router,windowId:this.windowId,selected:this.model.attributes.image}));this.selectorView.openDialog()},imageSelected:function(a){if(!a.windowId||a.windowId!=this.windowId||!a.imgId||this.model.get("imgId")&&this.model.get("imgId")==a.imgId)return;log("imgSelected",a);var b=this,c=App.collections.images.getUrl(a.imgId,"thumbnail");if(!this.imageWasSeleted){$("#image-field").removeClass("empty").html('<img src="'+c+'" />');$("#btn_select_image").html("Vælg nyt billede")}else $("#image-field img").attr("src",c);if(this.state=="edit")$("#img_src").val(a.imgId);else{var d={image:a.imgId};this.model.save(d,{success:function(a,c){log("success",a,c);c.success=="true"&&b.router.trigger("templateEdited",{event:"templateEdited"})},error:function(a,b){log("error",a,b)}})}},categoryChanged:function(a){if(this.state!="edit")return;var b=a.currentTarget.id;$(this.windowId+" .category.selected").removeClass("selected");$(this.windowId+" #"+b).addClass("selected")},cleanUp:function(){this.selectorView&&this.selectorView.closeDialog(!0)}})});define(["views/dialogs/dialog"],function(){App.views.dialogs.Feedback=App.views.Dialog.extend({el:"#content",initialize:function(){var a=this;this.template="feedbackReadmore";this.router=this.options.router;this.width=500;this.closable=!0;this.init(this.options);this.createDialog()}})});define(["views/dialogs/dialog","jquery/fileuploader","jquery/jquery.jcrop"],function(){App.views.dialogs.ImageSelectorView=App.views.Dialog.extend({el:"#content",initialize:function(){_.bindAll(this,"handleClick","imgUploaded","setJcrop","imgUploadProgress","imgBeforeSend","triggerUpload","goEdit","updateThumb","saveThumb","changedRevision","updatePreview","jcropOnSelect");var a=this;this.init(this.options);this.template="imageSelector";this.options.view?this.view=this.options.view:this.view="gallery";this.parentWindow=this.options.windowId;this.width=974;this.collection=App.collections.images;this.classes="black";this.maskClass="white";this.jcropapi;this.height=562;this.closable=!0;this.uploadField="#uploader-field-"+this.cid;this.currentPreview=!1;this.currentModel=!1;this.rotation=0;this.previewMaxSize=500;this.collection.on("change",this.changedRevision);this.destroyOnClose=!1;BrowserDetect.dragAndDrop()?this.dragable=!0:this.dragable=!1;var b={images:this.collection.toJSON(),view:this.view,cid:this.cid,dragable:this.dragable},a=this;this.options.selected&&(b.selected=this.options.selected);this.createDialog(b,function(
){var b=$("#uploader-"+a.cid)[0];if(a.dragable)var c=b;a.uploader=new qq.FileUploaderBasic({element:b,button:b,dragDrop:c,action:ROOT_URL+"ajax/upload.php",onSubmit:a.imgBeforeSend,onProgress:a.imgUploadProgress,onComplete:a.imgUploaded,allowedExtensions:["jpg","jpeg","png","gif"],sizeLimit:8388608})})},events:function(){var a={},b="#dialog-"+this.cid;a["click "+b+" .img-item"]="handleClick";a["click "+b+" .btn_edit"]="goEdit";a["click "+b+" #btn_rotate_left"]="doRotation";a["click "+b+" #btn_rotate_right"]="doRotation";a["click "+b+" #btn_edit_cancel"]="goGallery";a["click "+b+" #btn_edit_save"]="saveThumb";a["click "+b+" #btn_select_img"]="handleClick";a["click "+b+"#uploader-field-"+this.cid]="doUpload";a["click "+b+" #uploader-"+this.cid]="triggerUpload";return a},changedRevision:function(a,b){log("changedRevision");if(a.hasChanged("rev")){var c=a.get("id"),d=a.getUrl("thumbnail");$("#img_"+c).find("img").attr("src",d)}},updatePreview:function(){var a=this.currentModel,b=this;$(".contentpane").addClass("loading");var c=$("#preview_wrapper"),d=Math.round(($(".contentpane").width()-a.get("w"))/2),e=0;$("<img />").attr("src",a.getUrl("preview")).load(function(){var a=$(this),f=a.clone().attr("id","image_thumbnail");$("#thumbnail_wrapper").html(f);b.updateThumb();var g=a.attr("id","image_preview");c.queue("fx",function(){c.css({position:"absolute",left:d,top:e});c.find("img, .jcrop-holder").remove();c.append(g);$(".contentpane").removeClass("loading");$(this).dequeue()});c.fadeIn(function(){b.jcropapi||b.setJcrop()})})},setJcrop:function(){if(!this.currentModel)return;this.jcropapi&&this.jcropapi.destroy();var a=this,b=this.currentModel.get("t");$("#image_preview").Jcrop({onChange:a.updateThumb,onSelect:a.jcropOnSelect,aspectRatio:1,sideHandles:!1,setSelect:[b.x,b.y,b.x+b.w,b.y+b.h],minSize:[150,150]},function(){a.jcropapi=this})},imgUploaded:function(a,b,c){if(!c){log("Image is too big");this.afterUpload()}var d=new App.models.Image(c.data);this.collection.add(d);var e=d.get("id"),f=$("<img />").attr("src",d.getUrl("thumbnail")).load(function(){var b=$('<button class="button blue btn_edit" id="btn_edit_'+e+'">Tilpas</button>');$("#temp_img_"+a).removeClass("loading").html($(this)).append(b).attr("id","img_"+e)})},imgUploadProgress:function(a,b,c,d){var e=c/d*100;$("#temp_img_"+a).find(".progressbar span").width(e+"%")},imgBeforeSend:function(a,b){$("#uploader-"+this.cid).after('<div class="img-item loading" id="temp_img_'+a+'"><div class="progressbar"><span></span></div></div>')},imgShowError:function(a){log("error",a)},doUpload:function(a,b){if(!b)return!1},triggerUpload:function(){$("#dialog-"+this.cid+" #uploader-field-"+this.cid).trigger("click",!0)},handleClick:function(a){if(this.view=this.currentModel)if(this.thumbEdited){var b=this;$("#btn_select_img").html("&nbsp").addClass("loading");this.saveThumb(function(){$("#btn_select_img").removeClass("loading");b.selectImg(b.currentModel.get("id"))})}else this.selectImg(this.currentModel.get("id"));else{var c=a.currentTarget.id,d=c.substr(4),e=this.collection.get(d);e&&this.selectImg(e.get("id"))}},selectImg:function(a){$(this.dialogId+" .selected").removeClass("selected");$(this.dialogId+" #img_"+a).addClass("selected");this.router.trigger("imageSelected",{imgId:a,windowId:this.parentWindow});(this.view="edit")&&this.goGallery();this.closeDialog()},doRotation:function(a){if(this.jcropapi){this.jcropapi.destroy();this.jcropapi=null}if(!a||!a.currentTarget||!a.currentTarget.id)return;var b=this,c=a.currentTarget.id;if(c=="btn_rotate_left")var d=-90;else if(c=="btn_rotate_right")var d=90;if(d){$(".contentpane").addClass("loading");$("#preview_wrapper").fadeOut();d=this.currentModel.get("r")+d;this.currentModel.save({r:d},{success:function(a,c){c.success=="true"?b.updatePreview():log("error",c,a)},error:function(a,b){log("error",b,a)}})}},jcropOnSelect:function(a){if(!this.thumbEdited){$("#btn_edit_save").fadeIn();$("#btn_select_img").html("Gem og vælg");this.thumbEdited=!0}this.updateThumb(a)},updateThumb:function(a){if(this.currentModel){a||(a=this.currentModel.get("t"));if(this.thumbEdited){var b=$("#btn_edit_save"),c=a.y2-b.outerHeight()-10,d=a.x2-b.outerWidth()-10;$("#btn_edit_save").css({top:c,left:d})}var e=this,f=150/a.w,g=150/a.h,h=0,i=0;$("#image_thumbnail").css({width:Math.round(f*e.currentModel.get("w"))+"px",height:Math.round(g*e.currentModel.get("h"))+"px",marginLeft:-1*Math.round(f*a.x)+h+"px",marginTop:-1*Math.round(g*a.y)+i+"px"})}},saveThumb:function(a){if(!this.currentModel||!this.thumbEdited)return;$("#btn_edit_save").html("&nbsp").addClass("loading");var b=this,c={};if(this.jcropapi){var d=this.jcropapi.tellSelect();c.x=d.x;c.y=d.y;c.w=d.w;c.h=d.h}if(!_.isEqual(c,this.currentModel.get("t")))this.currentModel.save({t:c},{success:function(c,d){if(d.success=="true"){$("#btn_edit_save").fadeOut(function(){$(this).removeClass("loading").html("Gem")});$("#btn_select_img").html("Vælg billede");a&&$.isFunction(a)&&a();b.thumbEdited=!1}else log("error",d,c)},error:function(a,b){log("error",b,a)}});else{$("#btn_edit_save").fadeOut(function(){$(this).removeClass("loading").html("Gem")});$("#btn_select_img").html("Vælg billede");a&&$.isFunction(a)&&a();this.thumbEdited=!1}},goEdit:function(a){a.stopPropagation();var b=this,c=a.currentTarget.id,d=c.substr(9);b.currentModel=this.collection.get(d);this.updatePreview();this.changeView("edit")},goGallery:function(){if(this.jcropapi){this.jcropapi.destroy();this.jcropapi=null}this.currentModel=!1;this.changeView("gallery",function(){$("#image_preview, #image_thumbnail").remove()})},changeView:function(a,b){if(a=="edit"&&this.view=="gallery"){$("#gallery-view").hide("slide",{direction:"left",easing:"easeOutQuint"},500);$("#edit-view").show("slide",{direction:"right",easing:"easeOutQuint"},500);this.view="edit"}else if(a=="gallery"&&this.view=="edit"){$("#edit-view").hide("slide",{direction:"right",easing:"easeOutQuint"},500);$("#gallery-view").show("slide",{direction:"left",easing:"easeOutQuint"},500);this.view="gallery"}}})});define(["views/windows/window"],function(){App.views.windows.ViewShop=App.views.Window.extend({el:"#activity_administration",initialize:function(){this.template="viewshop";this.init(this.options);_.bindAll(this,"editShop","cancelEdit");this.state="view";this.depth=2;this.width=400;this.confirmClose=!0;this.inputPrefix="shop_";this.model=App.collections.shops.models[0];var a=this;this.createWindow(!0,{attributes:this.model.attributes,prefix:this.inputPrefix})},events:{"click #btn_edit_shop":"editShop","click input.readonly, textarea.readonly":"editShop","click #btn_cancel_shop":"cancelEdit","focus #opening-times input":"showTimes","blur #opening-times input":"hideTimes","click #opening-times .day, #opening-times .overlay":"selectDay"},setValidator:function(){var a=this;this.form=$(this.windowId).find("form");if(this.form){this.form.formValidate({submitKey:"#btn_edit_shop",rules:{shop_name:"required",shop_phone:"digits",shop_email:"email"}});$(this.form).find("input, textarea").focus(function(){a.lastFocus=$(this)})}},editShop:function(a){var b=this;if(this.state=="view"){$("#btn_edit_shop").html("Gem").addClass("blue");$("#btn_cancel_shop").css("display","block");$(this.windowId).formSetState("edit");this.state="edit";this.form||this.setValidator();$("#opening-times").addClass("edit");$("#"+a.currentTarget.id).is(":button")?this.lastFocus?this.lastFocus.focus():this.form.find("input[type=text]:first").focus():a.currentTarget.focus();this.important=!0;this.router.trigger("lock",{lock:"window",me:this.cid,activityCid:this.activity.cid,depth:this.depth})}else{var c={},d=$("#opening-times");for(var e=0;e<7;e++){c[e]={};c[e].open=d.find("#day-"+e+" input.opentime").val();c[e].close=d.find("#day-"+e+" input.closetime").val()}manual={open_hours:c};this.saveToModel({onChanged:function(){b.router.trigger("shopEdited",{event:"shopEdited"})},success:function(a,c){$("#btn_edit_shop").html("Rediger").removeClass("blue");$("#btn_cancel_shop").css("display","none");d.removeClass("edit").find(".notice").hide();b.state="view"},error:function(a,b){log("error",a,b)}},!1,manual);this.important=!1}return!1},cancelEdit:function(){this.state="view";this.setContent({attributes:this.model.attributes,prefix:this.inputPrefix});this.router.trigger("unlock",{lock:"window",activityCid:this.activity.cid,depth:this.depth});return!1},selectDay:function(a){if(this.state=="view")return;var b=$("#"+a.currentTarget.id).closest("li"),c=b.find(".overlay");c.fadeOut(200);b.find("input:first").focus()},showTimes:function(a,b){var c=$(a.currentTarget),d=c.closest("li"),e=d.find(".closed");e.is(":visible")&&e.fadeOut(300,function(){d.addClass("selected");e.css("display","")})},hideTimes:function(a){var b=$(a.currentTarget),c=b.closest("li"),d=c.find(".closed");empty=!0;b.val()&&b.val(convertToTimestring(b.val()));setTimeout(function(){c.find("input").each(function(){var a=$(this);if(a.val()||a.is(":focus"))empty=!1});empty?d.fadeIn(300,function(){c.removeClass("selected");d.css("display","")}):c.addClass("selected")},50)}})});define(["views/dialogs/dialog"],function(){App.views.dialogs.RegisterView=App.views.Dialog.extend({el:"#content",initialize:function(){var a=this;this.template="register";this.router=this.options.router;this.classes="register";this.init(this.options);this.closable=!0;this.createDialog({},function(){a.setValidator()});_.bindAll(this,"handleKeypress","doRegister","setValidator","handleClick")},events:{"click #register_button":"handleClick","click #go_login_button":"handleClick","keypress #register_username, #register_password, #betacode":"handleKeypress"},handleClick:function(a){log(this.router);a.currentTarget.id=="register_button"&&this.doRegister();a.currentTarget.id=="go_login_button"&&this.router.navigate("login",{trigger:!0})},handleKeypress:function(a){a.keyCode==13&&this.doRegister()},doRegister:function(){if(this.form&&this.form.valid()){$(this.dialogId+" input:focus").blur();this.router.doRegister()}else if(this.form){this.shakeDialog();this.form.submit()}},doOnOpen:function(){$("#register_username").focus()},setValidator:function(){this.form=$(this.dialogId).find("form");this.form&&this.form.formValidate({tooltipPosition:"center right",tooltipOffset:-5,rules:{user:{required:!0,email:!0,remote:{url:"ajax/shopowner.php",type:"post",data:{action:"test_username"}}},password:{required:!0,minlength:6},betacode:{required:!0,remote:{url:"ajax/shopowner.php",type:"post",data:{action:"test_betacode"}}}},messages:{user:{remote:jQuery.validator.format("Emailen er allerede optaget.<br /> Vælg venligst en anden email")},betacode:{remote:jQuery.validator.format("Den indtastede betakode er ugyldig")}}})}})});define(["views/dialogs/dialog"],function(){App.views.dialogs.Treasure=App.views.Dialog.extend({el:"#content",initialize:function(){var a=this;this.template="treasureReadmore";this.router=this.options.router;this.width=500;this.closable=!0;this.init(this.options);this.createDialog()}})});define(["views/dialogs/dialog"],function(){App.views.dialogs.ResetPassword=App.views.Dialog.extend({el:"#content",initialize:function(){_.bindAll(this,"handleKeypress","onOpen","handleClick");var a=this;this.init(this.options);this.template="resetPassword";this.router=this.options.router;this.closable=!0;this.width=380;this.height=222;this.createDialog({email:this.options.email},function(){$(a.dialogId).formValidate()})},events:{"click #btn_reset_button":"handleClick","keypress #reset_email":"handleKeypress"},success:function(){$("#newPassForm").fadeOut(400,function(){$("#newPassSuccess").fadeIn(400)})},error:function(){$(this.el).shakeBox()},handleClick:function(a){a.currentTarget.id=="btn_reset_button"&&this.router.doResetPass($("#reset_email").val());return!1},handleKeypress:function(a){if(a.keyCode==13){this.router.doResetPass($("#reset_email").val());return!1}},onOpen:function(){$("#reset_email").focus()}})});define(["text!templates/dashboard.html","order!raphael/raphael-min","order!jquery/jquery.analogueclock","views/feedback","views/notifications","views/activities/activity","views/activities/administration","views/activities/welcome","views/activities/overview","views/activities/templates","views/activities/startdeals","views/activities/welcome"],function(a){App.views.Dashboard=Backbone.View.extend({el:"#dashboard",animationTime:600,loadingActivity:!1,initialize:function(){this.router=this.options.router;this.activity=!1;this.activityRoutes={};this.model=App.models.shopowner;this.model.on("change:hours",this.renderHours,this);_.bindAll(this,"render","clickedActivity","dashboardLoaded","openRefill","lock","unlock","changeActivity");this.render();this.locked=!1;this.windowsLocked=!1},dashboardLoaded:function(){var a=this;App.views.notifications=new App.views.Notifications({router:this.router});new App.views.activities.Welcome({router:this.router});new App.views.activities.Overview({router:this.router});new App.views.activities.Templates({router:this.router});new App.views.activities.StartDeals({router:this.router});new App.views.activities.Administration({router:this.router});$("#dashboard").show();$("#menu").verticalAlign();$("#analogueclock").analogueClock({radius:8,strokeW:2,color:"rgb(69,69,69)"});App.collections.shops.length>0?this.animateMenu():App.collections.shops.bind("add",this.animateMenu);new App.views.Feedback({router:this.router});this.router.bind("lock",this.lock);this.router.bind("unlock",this.unlock)},animateMenu:function(){$("#menu").animate({"margin-left":"40px"},1e3,"easeInOutQuart");$("#activities").hasClass("newbie")&&$("#activities").animate({left:"200px"},500,"easeInOutQuart",function(){$(this).removeClass("newbie",300)})},lock:function(a){a.lock=="activity"&&(this.locked=!0)},unlock:function(a){a.lock=="activity"&&(this.locked=!1)},renderHours:function(a,b,c){log(a,b,c);$hoursEl=$("#hours_show");$hoursEl.html(a.get("hours")+" timer");$hoursEl.addClass("green");setTimeout(function(){$hoursEl.removeClass("green")},3e3)},render:function(){var b=this;$(b.el).html(_.template(a,{data:b.model.attributes}));b.dashboardLoaded()},events:{"click #menu li,#logo_top":"clickedActivity","click #btn_refill":"openRefill","click #btn_read_conditions":"openConditions"},clickedActivity:function(a){var b=a.currentTarget.id;if($("#"+b).hasClass("disabled"))return!1;if(b=="logo_top")c="welcome";else var c=b.substr(4);this.changeActivity({activity:c,clicked:!0})},changeActivity:function(a){if(a.hasOwnProperty("clicked")&&(a.activity==this.activity||this.locked))return!1;this.activity||(a.first=!0);this.activity==a.activity&&(a.dontChange=!0);this.activity=a.activity;this.router.trigger("clickedActivity",a)},openRefill:function(){var a=this;require(["views/dialogs/refill"],function(){a.refillView=new App.views.dialogs.Refill({router:a.router});a.refillView.openDialog()})},openConditions:function(){var a=this;require(["views/dialogs/conditions"],function(){a.conditionsView=new App.views.dialogs.Conditions({router:a.router});a.conditionsView.openDialog()})}})});define(["views/windows/window"],function(){App.views.windows.AccountSettings=App.views.Window.extend({el:"#activity_administration",initialize:function(){this.template="accountsettings";this.init(this.options);_.bindAll("cancelEdit");this.state="view";this.depth=2;this.width=425;this.confirmClose=!0;this.inputPrefix="user_";this.model=App.models.shopowner;this.createWindow(!0,{attributes:this.model.attributes,prefix:this.inputPrefix})},events:{"click #btn_edit_account":"editAccount","click input.readonly, textarea.readonly":"editAccount","click #btn_cancel_account":"cancelEdit"},setValidator:function(){var a=this;this.form=$(this.windowId).find("form");if(this.form){this.form.formValidate({submitKey:"#btn_edit_account",rules:{user_phone:"digits",user_pass_new:{minlength:6},user_pass:{required:function(a){return $("#user_pass_new").val()!=""&&$("#user_pass_again").val()!=""?!0:!1}}},messages:{user_pass:"Indtast nuværende password for verificere ændringer"}});$(this.form).find("input, textarea").focus(function(){a.lastFocus=$(this)})}},editAccount:function(a){if(this.state=="view"){$("#btn_edit_account").html("Gem").addClass("blue");$("#btn_cancel_account").css("display","block");$(this.windowId).formSetState("edit");this.state="edit";this.form||this.setValidator();$("#"+a.currentTarget.id).is(":button")?this.lastFocus?this.lastFocus.focus():this.form.find("input[type=text]:first").focus():a.currentTarget.focus();this.important=!0;this.router.trigger("lock",{lock:"window",me:this.cid,activityCid:this.activity.cid,depth:this.depth})}else{var b=this;$("#wrong_pass").is(":visible")&&$("#wrong_pass").slideUp();this.saveToModel({onChanged:function(){log("onChanged");b.router.trigger("settingsEdited",{event:"settingsEdited"})},success:function(a,c){log("success",c,a);$("#btn_edit_account").html("Rediger").removeClass("blue");$("#btn_cancel_account").css("display","none");b.state="view"},error:function(a,b){log("error",a,b);if(b.success=="false"&&b.error_message){if(b.error_message=="wrong_password"){$("#user_pass").val("");$("#user_pass_new").val("");$("#user_pass_again").val("");$("#wrong_pass").slideDown()}}else this.important=!1}})}return!1},cancelEdit:function(){this.state="view";this.setContent({attributes:this.model.attributes,prefix:this.inputPrefix});this.router.trigger("unlock",{lock:"window",activityCid:this.activity.cid,depth:this.depth});return!1},doEdit:function(a){if(this.state=="view"){$(this.windowId).formSetState("edit");this.form||this.setValidator();a.currentTarget.blur();a.currentTarget.focus();this.state="edit"}}})});define(["views/windows/window","order!jquery/jquery.scrollTo.min"],function(){App.views.windows.Feedback=App.views.Window.extend({el:"#activity_overview",width:420,depth:2,initialize:function(){_.bindAll(this,"feedbackChanged","sendFeedback","showTextfield","onCreated");this.template="feedback";this.init(this.options);this.collection=App.collections.feedback;this.textFocused=!1;this.createWindow(!0,this.collection.toJSON());App.collections.feedback.bind("change",this.feedbackChanged);App.collections.feedback.bind("add",this.feedbackChanged)},events:function(){var a={},b="#window-"+this.cid;a["click "+b+" #feedback-send-btn"]="sendFeedback";a["click "+b+" #feedback-textfield"]="showTextfield";return a},onCreated:function(){var a=this;$("#feedback-messages").scrollTo("max",500,{easing:"easeOutExpo"})},showTextfield:function(a){var b=this;a.stopPropagation();if(!this.textFocused){$("#feedback-text").addClass("focused");$("#feedback-messages").addClass("focused");setTimeout(function(){$("#feedback-messages").scrollTo("max",190)},90);this.textFocused=!0;$("html").click(function(a){if(b.textFocused){$("#feedback-text").removeClass("focused");$("#feedback-messages").removeClass("focused");b.textFocused=!1}$("html").unbind("click")})}},feedbackChanged:function(a,b){debug&&log("feedback har ændret",a,b.attributes);this.setContent(this.collection.toJSON(),function(){$("#feedback-messages").scrollTo("max")})},sendFeedback:function(a){a.stopPropagation();var b=this,c=$("#feedback-textfield").val();if(!c||c=="")return;if(c==this.feedback)alert("allerede sendt");else{this.feedback=c;$("#feedback-text").removeClass("focused");$("#feedback-messages").removeClass("focused");$("#feedback-messages").append('<div class="messageObj"><div class="message sent left">Sender meddelelse...</div></div>').scrollTo("max",200);var d=new App.models.Feedback;d.save({message:c},{success:function(a,b){App.collections.feedback.add(a);log("retur fra server",a,b)},error:function(a,c){log("fejl fra server",c);b.router.showError("Der opstod en fejl","Din feedback-besked blev ikke sendt korrekt<br />Fejlmeddelelse: "+c.error)},silent:!0})}}})});define(["views/windows/window"],function(){App.views.windows.Administration=App.views.Window.extend({el:"#activity_administration",initialize:function(){this.template="administration",this.width=300;this.init();this.createWindow(!0)},events:{"click #btn_admin_shops":"viewShop","click #btn_admin_user":"viewUser"},render:function(){},viewShop:function(a,b){this.router.navigate(lang.urls.administrationShop,{trigger:!0})},viewUser:function(a,b){this.router.navigate(lang.urls.administrationUser,{trigger:!0})}})});define(["views/windows/window","order!jquery/jcarousellite.min","views/dialogs/imageSelector"],function(){App.views.windows.AddTemplate=App.views.Window.extend({el:"#activity_templates",initialize:function(){_.bindAll(this,"addTemplate","changedModel","openSelectImage","imageSelected","categoryChanged");var a=this;this.template="addtemplate";this.init(this.options);this.depth=2;this.confirmClose=!0;this.important=!0;this.collection=App.collections.templates;this.createWindow(!0);this.render();this.router.bind("imageSelected",this.imageSelected)},render:function(){this.router.trigger("lock",{lock:"window",me:this.cid,activityCid:this.activity.cid,depth:this.depth});var a=this},events:function(){var a={},b="#window-"+this.cid;a["click "+b+" #btn_submit_add_template"]="addTemplate";a["click "+b+" #btn_select_image, "+b+" #image-field"]="openSelectImage";a["blur "+b+" #orig_price"]="priceChanged";a["keyup "+b+" #deal_price"]="priceChanged";a["click "+b+" .category"]="categoryChanged";return a},addTemplate:function(a){if(this.form&&this.form.valid()){var b={};b.title=$("#title").val();b.description=$("#description").val();b.orig_price=convertNumber($("#orig_price").val());b.deal_price=convertNumber($("#deal_price").val());b.image=$("#img_src").val();var c=$(".category.selected").attr("id");b.category=c.substr(4);this.model=new App.models.Template;this.model.save(b,{success:this.changedModel,error:this.changedModel,wait:!0})}else this.form&&this.form.submit()},changedModel:function(a,b){log("added",a,b);if(b.success=="true"){this.collection.add(this.model);App.views.notifications.notify("fast",lang.notifications.template.created);this.confirmClose=!1;this.activity.closeWindow(this)}else this.router.showError("Der opstod en fejl","Din skabelon blev ikke oprettet korrekt<br />Fejlmeddelelse: "+b.error)},onCreated:function(){var a=this;this.form=$(this.windowId).find("form");if(this.form){this.form.formValidate({submitKey:"#btn_submit_add_template",rules:{title:{required:!0,minlength:5},description:{required:!0,minlength:5},orig_price:{required:!0,danishNumber:!0,saving:!0},deal_price:{required:!0,danishNumber:!0,saving:!0}},groups:{prices:"orig_price deal_price"},messages:{orig_price:{required:"Udfyld venligts prisfelterne"},deal_price:{required:"Udfyld venligst prisfelterne"}},errorPlacement:function(a,b){if(b.attr("name")=="orig_price"||b.attr("name")=="deal_price")$("#prices-error").html(a);else{var c=b.parents(".field");c?a.appendTo(c):a.insertAfter(b)}}});$(this.form).find("input, textarea").focus(function(){a.lastFocus=$(this)});$(a.windowId+" #image-selector").slides({preload:!0,preloadImage:"styles/stylesheets/i/loader2.gif",animationComplete:function(b){var c=$(a.windowId+" #image-selector").find(".slides_container .slides_control div");c=c.get(b-1);c?c=$(c).find("img").attr("src"):c="";log(c);$("#img_src").val(c)}});$(a.windowId+" #image-selector").find(".curtain").remove();this.form.find("input[type=text]:first").focus()}},priceChanged:function(){var a=$("#orig_price").val(),b=$("#deal_price").val();calcDiscount(a,b,"#discount-field")},openSelectImage:function(){this.selectorView||(this.selectorView=new App.views.dialogs.ImageSelectorView({router:this.router,windowId:this.windowId}));this.selectorView.openDialog()},imageSelected:function(a){if(!a.windowId||a.windowId!=this.windowId||!a.imgId)return;var b=App.collections.images.getUrl(a.imgId,"thumbnail");if(!this.imageWasSeleted){$("#image-field").removeClass("empty").html('<img src="'+b+'" />');$("#btn_select_image").html("Vælg nyt billede")}else $("#image-field img").attr("src",b);this.imageWasSelected=!0;$("#img_src").val(a.imgId)},categoryChanged:function(a){var b=a.currentTarget.id;$(this.windowId+" .category.selected").removeClass("selected");$(this.windowId+" #"+b).addClass("selected")},cleanUp:function(){this.selectorView&&this.selectorView.closeDialog(!0)}})});define(["views/windows/window"],function(){App.views.windows.MyDeals=App.views.Window.extend({el:"#activity_overview",depth:2,deals:{current:[],planned:[],ended:[]},initialize:function(){var a=this;this.init(this.options);_.bindAll(this,"updateContent","stateChanged","viewDeal","changeTab","onDealAdded","onDealChanged","removeDeal","confirmRemoveCallback");this.template="mydeals";this.tabId="deals-tab-current";this.collection=App.collections.deals;this.options.dealId?this.currentDeal=this.collection.get(this.options.dealId):this.currentDeal=null;this.currentDeal?this.view="deal-details":this.view="deal-list";var b=this.updateContent(!1),c="text!templates/component/viewDeal.html";require([c],function(c){a.dealViewHtml=c;a.currentDeal&&(b.dealView=_.template(c,{data:a.currentDeal.toJSON()}));a.createWindow(!0,b)});App.collections.deals.bind("add",this.onDealAdded);App.collections.deals.bind("change",this.onDealChanged);App.collections.deals.bind("remove",this.updateContent);this.router.bind("promtCallback:"+this.cid,this.confirmRemoveCallback)},updateContent:function(a){var b=this,c=this.sortDeals();c.tabId=this.tabId;c.view=this.view;c.currentDeal=this.currentDeal;this.dealViewHtml&&this.currentDeal&&(c.dealView=_.template(this.dealViewHtml,{data:this.currentDeal.toJSON()}));if(!a)return c;this.setContent(c)},onDealChanged:function(a,b){log("onDealChanged",a,b);if(a.hasChanged("state"))this.stateChanged(a.get("id"));else if(a.hasChanged("status")&&a.get("status")=="soldout"){$("#deal-"+a.get("id")).find(".soldout").show();if(this.currentDeal&&this.currentDeal.get("id")==a.get("id")){var c=$("#view-"+this.currentDeal.get("id"));log(c);c.find(".remove-btn").hide().end().find(".soldout").show()}}else this.updateContent(!0)},onDealAdded:function(a,b){this.currentDeal=a;this.view="deal-details";this.updateContent(!0)},sortDeals:function(){var a=this,b=this.collection.toJSON();this.deals={current:[],planned:[],ended:[]};_.each(b,function(b){b.state&&a.deals[b.state]&&a.deals[b.state].push(b)});return this.deals},stateChanged:function(a){var b=this,c=this.collection.get(a).toJSON();if(c){var d=$("#deal-"+c.id),e=c.state,f=d.parent(".deal-list").attr("id").substr(6);e!=f&&d.slideUp("300",function(){var a;if(b.deals[f].length===1){a=$("#deals-"+f).find(".empty-block");a.is(":visible")?a.fadeIn("slow"):a.css({display:"block"})}if(b.deals[e].length===0){a=$("#deals-"+e).find(".empty-block");a.is(":visible")?a.fadeOut("slow"):a.css({display:"none"})}$(this).prependTo("#deals-"+e).slideDown()})}},events:function(){var a={};a["click "+this.windowId+" .deal-item"]="viewDeal";a["click "+this.windowId+" .tab-link"]="changeTab";a["click "+this.windowId+" #btn_deal_back"]="viewList";a["click "+this.windowId+" #btn_remove_deal"]="removeDeal";return a},viewDeal:function(a){var b=a.currentTarget.id;b=b.substr(5);this.router.navigate(lang.urls.overviewDeals+"/"+b,{trigger:!0})},viewList:function(){this.router.navigate(lang.urls.overviewDeals,{trigger:!0})},showDeal:function(a){this.currentDeal=this.collection.get(a);if(this.currentDeal){$("#btn_deal_back").show();$("#view-deal-details").html(_.template(this.dealViewHtml,{data:this.currentDeal.toJSON()}));this.changeView("deal-details")}},showList:function(){this.currentDeal=null;this.changeView("deal-list");$("#btn_deal_back").hide()},removeDeal:function(){if(this.currentDeal){var a=parseInt((new Date).getTime()/1e3,10),b;this.state!="current"?(b="Er du sikker på du ønsker at slette denne deal?",btn_txt="Slet"):(b="Er du sikker på du ønsker at melde denne deal udsolgt?",btn_txt="Meld udsolgt");var c=new App.views.dialogs.PromtDialog({router:this.router,type:"confirm",callbackCid:this.cid,title:b,confirmText:btn_txt})}return!1},confirmRemoveCallback:function(a){log("remove",a,this.currentDeal);var b=this;a.callbackCid==this.cid&&a.type=="confirm"&&this.currentDeal&&(a.eventType=="confirm"?this.currentDeal.get("state")=="current"?this.currentDeal.save({status:"soldout"},{success:function(a,b){log("Deal soldout",a,b)},error:function(a,c){log("Deal soldout error",a,c);b.router.showError("Der opstod en fejl","Det lykkedes ikke at melde din deal udsolgt<br />Fejlmeddelelse: "+c.error)}}):this.currentDeal.destroy({data:this.currentDeal.id,success:function(a,c){log("deleted",a,c);b.router.trigger("dealEdited",{event:"dealDeleted"});b.activity.closeWindow(b,!1,!0)},error:function(a,c){log("error delete: ",a,c);b.router.showError("Der opstod en fejl","Det lykkedes ikke at slette din deal<br />Fejlmeddelelse: "+c.error)}}):this.router.trigger("setFocus",{activity:this.activity,windowCid:this.cid}))},changeTab:function(a){var b=a.currentTarget.id,c="deals-tab-"+b.substr(4);if(c!=this.tabId){$("#"+this.tabId).hide();$("#"+c).show();$(this.windowId).find(".tab-link.selected").removeClass("selected");$("#"+b).addClass("selected");this.tabId=c}},changeView:function(a){a!=this.view&&$(this.windowId+" .tab-block").css("overflow-y","visible");if(a=="deal-details"&&this.view=="deal-list"){$("#view-deal-list").hide("slide",{direction:"left",easing:"easeOutQuint"},400);$("#view-deal-details").show("slide",{direction:"right",easing:"easeOutQuint"},400);this.view="deal-details"}else if(a=="deal-list"&&this.view=="deal-details"){$("#view-deal-details").hide("slide",{direction:"right",easing:"easeOutQuint"},400);$("#view-deal-list").show("slide",{direction:"left",easing:"easeOutQuint"},400);this.view="deal-list"}a!=this.view&&$(this.windowId+" .tab-block").css("overflow-y","auto")},cleanUp:function(){App.collections.deals.unbind("add",this.onDealAdded);App.collections.deals.unbind("change",this.onDealChanged);App.collections.deals.unbind("remove",this.updateContent)}})});define([],function(){App.views.Entry=Backbone.View.extend({el:"body",initialize:function(){_.bindAll(this,"doOnOpen","handleClick");var a=this;this.router=this.options.router;this.created=!1;this.render()},events:{"click #login_button, #btn_read_conditions,#btn_forgot_pass,#go_register_button,#do_register_button,#cancel_register_button":"handleClick","keypress #login_username, #login_password":"handleKeypressLogin","keypress #register_username, #register_password, #register_betacode":"handleKeypressRegister"},render:function(){var a="text!templates/entry.html",b=this;require([a],function(a){$("body").append(_.template(a,{view:b.router.view}));b.form=$("#register-form");$("#entry_view").formValidate({rules:{register_username:{required:!0,email:!0,remote:{url:ROOT_URL+"ajax/shopowner.php",type:"post",data:{action:"test_username"}}},register_password:{required:!0,minlength:6},register_betacode:{required:!0,remote:{url:"ajax/shopowner.php",type:"post",data:{action:"test_betacode"}}},register_accept_terms:{required:!0}},messages:{register_username:{remote:jQuery.validator.format("Den indtastede email er allerede registreret<br /> Log ind eller vælg en anden")},register_betacode:{remote:jQuery.validator.format("Den indtastede betakode er ugyldig")},register_accept_terms:{required:jQuery.validator.format("Betingelser skal godkendes")}},errorPlacement:function(a,b){var c=b.closest(".field");c?a.appendTo(c):a.insertAfter(b);var d=b.position().top+(b.outerHeight()-a.outerHeight())/2+1,e=-(a.outerWidth()+15);a.css({top:d+"px",left:e+"px"})}});b.router.view=="register"?$("#register_username").focus():$("#login_username").focus();b.created=!0})},shakeDialog:function(){$("#shadow-wrapper").shakeBox(!1)},handleClick:function(a){switch(a.currentTarget.id){case"btn_forgot_pass":this.router.openResetPass($("#login_username").val());break;case"btn_read_conditions":this.router.openConditionsView();break;case"login_button":this.router.doLogin();break;case"go_register_button":this.router.navigate("register",{trigger:!0});break;case"do_register_button":this.form&&this.form.valid()&&this.router.doRegister();break;case"cancel_register_button":this.router.navigate("login",{trigger:!0})}return!1},handleKeypressLogin:function(a){a.keyCode==13&&this.router.doLogin()},handleKeypressRegister:function(a){a.keyCode==13&&(this.form&&this.form.valid()?this.router.doRegister():this.form.submit())},doOnOpen:function(){$("#login_username").focus()}})});define(["text!templates/component/window.html"],function(a){App.views.Window=Backbone.View.extend({hasLocked:!1,hasFocus:!0,selectedLink:null,depth:1,windowId:"",init:function(){_.bindAll(this,"handleLock","lock","handleUnlock","setFocus","closeWindow","setHandlers","setContent","openWindow","setSelected","removeSelected","onCreated","hasChanged","saveToModel");this.windowId="#window-"+this.cid;this.router=this.options.router;this.options.activity&&(this.activity=
this.options.activity);this.options.parent&&(this.parent=this.options.parent);this.options.depth&&(this.depth=this.options.depth);this.html="";this.openOnCreate=!1;this.router.bind("setFocus",this.setFocus);this.router.bind("lock",this.handleLock);this.router.bind("unlock",this.handleUnlock)},lock:function(a){var b=this;switch(a){case"lock":this.locked=!0;this.hasFocus=!1;$(this.windowId).createMask(function(){b.router.trigger("setFocus",{windowCid:b.cid})});break;case"unlock":this.locked=!1;$(this.windowId).removeMask()}},handleLock:function(a){if(a.lock=="window"&&!this.locked){a.me==this.cid&&(this.hasLocked=!0);a.activityCid==this.activity.cid&&this.depth==a.depth-1&&this.lock("lock")}},handleUnlock:function(a){a.lock=="window"&&a.activityCid==this.activity.cid&&this.depth==a.depth-1&&this.lock("unlock")},setFocus:function(a){if(a.windowCid==this.cid){this.locked&&this.lock("unlock");this.lastFocus&&this.lastFocus.focus();this.important&&this.router.trigger("lock",{lock:"window",me:this.cid,activityCid:this.activity.cid,depth:this.depth});this.hasFocus=!0}else this.hasFocus=!1},createWindow:function(b,c,d){this.html=_.template(a,{data:this});b&&this.setContent(c,d)},openWindow:function(){if(!this.created){this.openOnCreate=!0;return}var a=this,b=$("#"+this.activity.id);a.parent&&a.activity.windows[a.parent]&&a.activity.windows[a.parent].removeLinkLoading();$(a.html).hide().appendTo(b).fadeIn(400,function(){a.setHandlers();$(a.windowId).click(function(){if(a.important&&!a.hasFocus){a.router.trigger("lock",{lock:"window",me:a.cid,activityCid:a.activity.cid,depth:a.depth});a.hasFocus=!0}});a.onCreated()})},setHandlers:function(){var a=this;$("#close-"+this.cid).click(function(b){b.stopPropagation();a.activity?a.activity.closeWindow(a,!1,!0):a.closeWindow()})},cleanUp:function(){},onCreated:function(){},closeWindow:function(a){this.cleanUp();this.hasLocked&&this.router.trigger("unlock",{lock:"window",activityCid:this.activity.cid,depth:this.depth});var b=this;$(this.windowId).fadeOut(400,function(){b.undelegateEvents();$(this).remove();a&&a()})},setContent:function(a,b){var c=this,d="text!templates/windows/"+this.template+".html";a?a.selectedLink=this.selectedLink:a={selectedLink:this.selectedLink};require([d],function(d){if(c.created){$(c.windowId+" .content").html(_.template(d,{data:a}));c.html=$(c.windowId)}else{var e=$(c.html);e.find(".content").html(_.template(d,{data:a}));c.html=e;c.created=!0;c.openOnCreate&&c.openWindow()}b&&b();a&&!a.selectedLink&&c.selectedLink&&c.setSelected(c.selectedLink)})},setSelected:function(a){this.removeSelected();$(this.windowId).find("#"+a).addClass("selected");this.selectedLink=a},removeSelected:function(){if(this.selectedLink){$(this.windowId).find("#"+this.selectedLink).removeClass("selected");this.selectedLink=null}},setLinkLoading:function(a){this.removeLinkLoading();$(this.windowId).find("#"+a).createMask(!1,"loading");this.loadingItem=a},removeLinkLoading:function(){if(this.loadingItem){$(this.windowId).find("#"+this.loadingItem).removeMask();this.loadingItem=null}},hasChanged:function(){var a=!1;$(this.windowId).find(".field").find("input, textarea").each(function(){var b=$(this);if(b.val()!=""&&(!b.attr("oldValue")||b.attr("oldValue")==""||b.attr("oldValue")!=b.val())){a=!0;return}});return a},saveToModel:function(a,b,c){if(this.form&&this.form.valid()){var d=this;a||(a={});var e={};$(this.windowId).find(".field").find("input, textarea").each(function(){if($(this).val()&&(!$(this).attr("oldValue")||$(this).attr("oldValue")!=$(this).val())){var a=$(this).attr("id");d.inputPrefix&&d.inputPrefix.length!=0&&(a=a.substr(d.inputPrefix.length));var b=$(this).val();if(a=="orig_price"||a=="deal_price")b=convertNumber(b);e[a]=b;$(this).attr("oldValue")&&$(this).attr("oldValue",$(this).val())}});_.each(c,function(a,b){e[b]=a});if(!$.isEmptyObject(e))this.model.save(e,{success:function(c,e){log("success",c,e);$(d.windowId).find(".field").find("input[type=password]").val("");if(e.success=="true"){d.lock&&d.router.trigger("unlock",{lock:"window",activityCid:d.activity.cid,depth:d.depth});a.success&&a.success(c,e);a.onChanged&&a.onChanged(c,e);b||$(d.windowId).formSetState("readonly")}else{d.router.showError("Der opstod en fejl","Dine ændringer blev ikke gemt<br />Fejlmeddelelse: "+e.error);a.error&&a.error(c,e)}},error:function(b,c){d.router.showError("Der opstod en fejl","Dine ændringer blev ikke gemt<br />Fejlmeddelelse: "+c.error);a.error&&a.error(b,c)},wait:!0});else{this.lock&&this.router.trigger("unlock",{lock:"window",activityCid:this.activity.cid,depth:this.depth});a.success&&a.success();b||$(this.windowId).formSetState("readonly")}this.state="view"}else this.form&&this.form.submit()}})});define(["views/windows/window"],function(){App.views.windows.MyTemplates=App.views.Window.extend({el:"#activity_templates",initialize:function(){this.template="mytemplates";this.width=350;this.init(this.options);_.bindAll(this,"updateContent");this.collection=App.collections.templates;this.createWindow(!0,this.collection.toJSON());App.collections.templates.bind("add",this.updateContent);App.collections.templates.bind("change",this.updateContent);App.collections.templates.bind("remove",this.updateContent)},updateContent:function(a,b){this.setContent(this.collection.toJSON())},events:{"click .template_item":"viewTemplate","click #btn_add_template":"addTemplate"},viewTemplate:function(a){var b=a.currentTarget.id,c=b.substr(9);this.router.navigate(lang.urls.templates+"/"+c,{trigger:!0})},addTemplate:function(){this.router.navigate(lang.urls.templatesAdd,{trigger:!0})},cleanUp:function(){App.collections.templates.unbind()}})});define(["text!templates/feedback.html"],function(a){App.views.Feedback=Backbone.View.extend({el:"#workspace",initialize:function(){_.bindAll(this,"render","feedbackClick","closeFeedback","show");this.router=this.options.router;var a=this;this.object="#feedback";this.openHeight=290;this.closedHeight=100;this.open;this.feedback;this.model=App.models.feedback;if(App.collections.shops.length>0)this.render(1);else{this.render();App.collections.shops.bind("add",this.show)}},events:{"click #feedback":"feedbackClick","click #btn_send_feedback":"sendFeedback","click #read_more":"openDialog","mouseenter #feedback":"feedbackMouseOver","mouseleave #feedback":"feedbackMouseOut"},render:function(b){$(a).hide().appendTo(this.el);b&&this.show()},show:function(){if(!!this.shown)return!1;var a=this;$(function(){a.shown=!0;$(a.object).verticalAlign().fadeIn(400)})},closeFeedback:function(a){if(this.open){this.open=!1;$("html").unbind("click");this.animateFeedback(a)}},feedbackClick:function(a){a.stopPropagation();if(!this.open){var b=this;this.open=!0;$("html").click(function(a){b.closeFeedback("close")});this.animateFeedback("open")}},feedbackMouseOver:function(a){var b=this;this.open||$(this.object).animate({width:70},{queue:!1,duration:500,easing:"easeOutExpo"})},feedbackMouseOut:function(a){var b=this;this.open||$(this.object).animate({width:50},{queue:!1,duration:500,easing:"easeOutElastic"})},animateFeedback:function(a){var b=this;if(a=="open"){this.positionTop=$(this.object).position().top;$(this.object).stop(!0).animate({width:"400px"},200,"easeInQuad").animate({top:b.positionTop-b.openHeight/2+b.closedHeight/2+"px",height:b.openHeight+"px"},200,"easeInQuad").children();$(this.object+"_text").fadeOut(25);$(this.object+" div:last-child").delay(400).fadeIn(function(){$("#feedback_text_area").focus()})}else if(a=="close"){$(this.object+" div:last-child").fadeOut(200);$(this.object).delay(200).animate({top:b.positionTop+"px",height:"100px"},200,"easeOutQuad").animate({width:"50px"},200,"easeOutQuad");$(this.object+"_text").delay(400).fadeIn(25)}else if(a=="thanksmessage"){$(this.object+" div:last-child").fadeOut(400);$(this.object).delay(400).animate({top:b.positionTop+"px",height:"100px"},400).delay(4e3).animate({width:"50px"},400);$(this.object+"-thanks").delay(900).fadeIn(400).delay(3100).fadeOut(400);$(this.object+"_text").delay(5200).fadeIn(50,function(){b.open=!1})}},openDialog:function(){var a=this;require(["views/dialogs/feedback"],function(){a.readmore=new App.views.dialogs.Feedback({router:a.router});a.readmore.openDialog()})},sendFeedback:function(){if(!this.shown)return;var a=$("#feedback_text_area").val();if(a==this.feedback)alert("allerede sendt");else{$("html").unbind("click");this.animateFeedback("thanksmessage");var b=new App.models.Feedback;b.save({message:a},{success:function(a,b){log("success feedback sent",a,b);App.collections.feedback.add(a)},error:function(a,b){log(a,b);thisClass.router.showError("Der opstod en fejl","Din feedback-besked blev ikke sendt korrekt<br />Fejlmeddelelse: "+b.error)}})}}})});define(["text!templates/component/dialog.html"],function(a){App.views.Dialog=Backbone.View.extend({init:function(a){_.bindAll(this,"handle","createDialog","closeDialog","openDialog","setHandlers","setContent","onClose");this.dialogId="#dialog-"+this.cid;this.router=a.router;this.options.classes&&(this.classes=this.options.classes);this.options.onClose&&(this.onClose=this.options.onClose);this.created=!1;this.openOnCreate=!1;this.destroyOnClose=!0;this.aniTime=400;this.maskClass="black"},createDialog:function(b,c){var d=this,e=_.template(a,{data:this});$(e).hide().appendTo(d.el);this.setContent(b,c);this.setHandlers();$(window).resize(function(){$(d.dialogId).centerBox()});$(this.dialogId).centerBox();this.created=!0;this.openOnCreate&&this.openDialog()},openDialog:function(){this.router.trigger("dialogOpened",{me:this.cid});this.router.bind("dialogOpened",this.handle);var a=this;$("body").createMask(function(b){b.stopPropagation();a.closable&&a.closeDialog(a.destroyOnClose)});this.created?$(this.dialogId).fadeIn(a.aniTime,function(){$(this).show();a.onOpen&&a.onOpen()}):this.openOnCreate=!0},setHandlers:function(){if(this.closable){var a=this;$("#close-"+this.cid).click(function(b){b.stopPropagation();a.closeDialog(a.destroyOnClose)})}},closeDialog:function(a,b){var c=this;$("body").removeMask(this.aniTime);$(this.dialogId).fadeOut(c.aniTime,function(){b||c.onClose();if(a){c.undelegateEvents();$(this).remove()}})},shakeDialog:function(){$(this.dialogId).shakeBox()},setContent:function(a,b){var c=this,d="text!templates/dialogs/"+this.template+".html";require([d],function(d){$("#dialog-"+c.cid+" .content").html(_.template(d,{data:a}));b&&b()})},handle:function(a){if(a.me==this.cid)return;this.closeDialog()},onClose:function(){}})});define(["views/dialogs/dialog"],function(){App.views.dialogs.Conditions=App.views.Dialog.extend({el:"#content",initialize:function(){var a=this;this.init(this.options);this.template="conditions";this.router=this.options.router;this.width=600;this.height=600;this.closable=!0;this.createDialog()}})});var lang={urls:{templates:"skabeloner",overview:"oversigt",startdeals:"start",administration:"administration",administrationUser:"administration/bruger",administrationShop:"administration/butik",templatesAdd:"skabeloner/tilfoej",overviewDeals:"oversigt/deals",overviewFeedback:"oversigt/feedback"},ui:{templates:{}},notifications:{feedback:{response:"Der er kommet svar på din feedback!",sent:"Din feedback er sendt, og vi svarer så hurtigt som muligt"},account:{edited:"Dine indstillinger er blevet ændret"},deal:{planned:"Din deal er nu planlagt. Held og lykke!",started:"En deal er lige startet. Klik for at se hvilken.",ended:"En deal er netop afsluttet. Klik for at se hvilken.",deleted:"En deal er blevet slettet",soldout:"En deal er blevet meldt udsolgt"},shop:{created:"Din butik er blevet oprettet og afventer nu godkendelse fra os! Imens kan du jo gå igang med at oprette dine skabeloner",edited:"Dine ændringer er blevet gemt",approved:"Din butik er blevet godkendt, jubiii!",declined:"Din butik er desværre afslået"},template:{created:"Din skabelon er blevet tilføjet og afventer nu godkendelse. Vi skynder os!",edited:"Din skabelon er blevet ændret og afventer nu igen godkendelse fra os",deleted:"Din skabelon er blevet slettet",approved:"Din skabelon er blevet godkendt! God fornøjelse",declined:"Din skabelon er desværre blevet afvist. Skynd dig ind og se hvorfor"}}};define(["text!templates/notifications.html"],function(a){App.views.Notifications=Backbone.View.extend({el:"#workspace",initialize:function(){_.bindAll(this,"notify","eventHandling","changesHandling","changeRoute","dealChanged","dealAdded");this.router=this.options.router;var a=this;this.object="#notifications";this.render();this.router.bind("notification",this.notify);this.router.bind("dealEdited",this.eventHandling);this.router.bind("shopCreated",this.eventHandling);this.router.bind("templateEdited",this.eventHandling);this.router.bind("settingsEdited",this.eventHandling);App.collections.deals.bind("change",this.dealChanged)},eventHandling:function(a,b){if(!a&&!a.event)return!1;var c;switch(a.event){case"deal_started":c=lang.notifications.deal.started;break;case"deal_planned":c=lang.notifications.deal.planned;break;case"deal_deleted":c=lang.notifications.deal.deleted;break;case"shopCreated":c=lang.notifications.shop.created;break;case"templateEdited":c=lang.notifications.template.edited;break;case"templateDeleted":c=lang.notifications.template.deleted;break;case"settingsEdited":c=lang.notifications.account.edited}c&&this.notify("fast",c)},dealChanged:function(a){if(a.hasChanged("state")||a.hasChanged("status")){var b=null;a.get("status")=="soldout"?b=lang.notifications.deal.soldout:a.get("state")=="current"?b=lang.notifications.deal.started:a.get("state")=="ended"&&(b=lang.notifications.deal.ended);var c=lang.urls.overviewDeals+"/"+a.get("id");b&&this.notify("fast",b,c)}},dealAdded:function(a,b){},changesHandling:function(a,b){log("changes",a,b);var c;c=lang.notifications[a.type]&&lang.notifications[a.type][a.action]?lang.notifications[a.type][a.action]:"";this.notify("fast",c,b)},changeRoute:function(a){this.router.navigate(a,{trigger:!0})},notify:function(a,b,c){if(!b)return;var d,e;a=="fast"?d=5e3:a=="slow"?d=3e4:d=Infinity;a=="sticky"&&(e=!0);var f=this;setTimeout(function(){$.meow({message:b,closeable:!1,duration:d,sticky:e,route:c,callback:f.changeRoute})},500)},render:function(b){$(a).appendTo(this.el)}})});define(["text!templates/startdeal.html","views/component/templateSelector","order!jquery/jquery-ui","order!jquery/jquery.ui.timepicker.addon","order!jquery/jquery.ui.datepicker-da"],function(a){App.views.StartDeal=Backbone.View.extend({el:"#activity_startdeals",initialize:function(){_.bindAll(this,"startDeal","render","updateTemplates","setTemplateSelected","setVerticalAlign","handleEvent");this.templateName="startdeal";this.elemId="start_deal";this.dealTemplates={};this.showTimeType="type-now";this.dateSelected=!1;this.vAligned=!1;this.router=this.options.router;this.activity=this.options.activity;this.timeStandard=5;this.timeMinInterval=10;this.templateSelected=null;this.render();this.router.bind("appendWindow",this.handleEvent);this.router.bind("templatesUpdated",this.updateTemplates);this.router.bind("templateSelected",this.setTemplateSelected)},render:function(){var b=this;$(this.el).html(_.template(a,{data:this}));this.$el=$("#start_deal");this.first=!0;this.expanded=!1;this.starting=!1;this.hours=null;this.$el.find("#deal_start_time").datetimepicker({stepMinute:b.timeMinInterval,hourGrid:4,minuteGrid:b.timeMinInterval,minDate:getTimeString(!1,!0),timeFormat:"hh:mm",onClose:function(a,c){b.dateSelected||(b.dateSelected=!0);b.updateHours(!0)},onSelect:function(a){var c=$(this).datetimepicker("getDate").getTime(),d=$("#deal_end_time");d.datetimepicker("option","minDate",new Date(c));var e=dateToAmr(a),f=e;if(d.val()!=="")var g=dateToAmr(d.val());else var g=new Date(0);if(!b.dateSelected||d.val()===""||f>g){var h=b.hours?b.hours:b.timeStandard,i=f.getTime()+36e5*h;d.val(getTimeString(i,!0,b.timeMinInterval))}b.updateHours()}});$("#btn_submit_start_deal",this.$el).on("click",this.startDeal);this.$el.find("#treasure_read_more").click(function(){b.treasureDialog()});this.$el.find("#deal_end_time").datetimepicker({stepMinute:b.timeMinInterval,hourGrid:4,minuteGrid:b.timeMinInterval,timeFormat:"hh:mm",minDate:getTimeString(!1,!0),onClose:function(a,c){dateAmr=dateToAmr(a);var d=$("#deal_start_time");if(d.val()!=""){var e=dateToAmr(d.val()),f=dateAmr;e>f&&d.val(a)}else d.val(a);b.updateHours(!0)},onSelect:function(a){b.updateHours()}});this.selectorView=new App.views.components.TemplateSelectorView({router:this.router,appendTo:"#select-template-list",expandOnCreate:this.templateSelected===null,parent:this.cid,onExpand:function(){b.expanded?b.collapse():b.setVerticalAlign()},onCollapse:this.setVerticalAlign,onCreated:function(){b.setVerticalAlign()}});return!0},handleEvent:function(a){if(a.window&&a.window==="startWithTemplate"){var b=this;this.templateSelected=a.id;this.selectorView&&this.selectorView.setSelected(a.id)}},setVerticalAlign:function(a){if(!this.$el.is(":visible")){this.$el.css({position:"absolute",visibility:"hidden",display:"block"});this.$el.verticalAlign(this.vAligned,a);this.$el.css({visibility:"visible"})}else{var b=$.extend({},a,{animate:!0});this.$el.verticalAlign(this.vAligned,b)}this.vAligned=!0},updateTemplates:function(a){this.dealTemplates=a},setTemplateSelected:function(a){if(a&&a.parent===this.cid&&a.templateId){var b=a.templateId;this.templateSelected=b;this.router.navigate(lang.urls.startdeals+"/"+this.templateSelected);this.expand()}},expand:function(){if(!this.expanded&&this.templateSelected){var a=this;$("#deal_start_time").val(getTimeString(0,!0,this.timeMinInterval));var b=(new Date).getTime()+36e5*this.timeStandard;$("#deal_end_time").val(getTimeString(b,!0,this.timeMinInterval));var c=$("#set_template_block");if(!this.$el.is(":visible"))$("#stage-two").css({position:"relative",top:"0px"}).show();else{var d=$("<div />").css({overflowY:"hidden",width:"100%"});$("#stage-two").wrap(d).css({position:"relative",top:-$("#stage-two").outerHeight()-20}).show().animate({top:0},{duration:1e3,easing:"easeOutExpo",complete:function(){$(this).unwrap()},queue:!1})}a.setVerticalAlign();this.expanded=!0}},collapse:function(a){if(this.expanded){var b=this;b.router.navigate(lang.urls.startdeals);$("#deal_templates").val("");var c=this.selectorView?$("#set_template_block").outerHeight()-this.selectorView.collapsedHeight+this.selectorView.expandedHeight:0,d=$("<div />").css({overflowY:"hidden",width:"100%"});$("#stage-two").wrap(d).animate({top:-$("#stage-two").outerHeight()-20},{duration:1e3,easing:"easeOutExpo",complete:function(){b.expanded||$(this).hide();$(this).unwrap()},queue:!1});a&&this.selectorView&&this.selectorView.resetSelected();this.setVerticalAlign({meHeight:c});this.expanded=!1;this.templateSelected=null}},updateHours:function(a){var b=$("#deal_start_time").datetimepicker("getDate"),c=$("#deal_end_time").datetimepicker("getDate"),d=c.getTime()-b.getTime(),e=Math.round(d/1e3/60),f=padNumber(e%60),g=Math.round(e/60);a&&(this.hours=g);$("#deal_hours").html(g)},resetStarter:function(a){if(!this.expanded)return;var b=this;if(a)setTimeout(function(){b.dateSelected=!1;b.selectorView&&b.selectorView.resetSelected();b.render()},1e3);else{b.dateSelected=!1;b.selectorView&&b.selectorView.resetSelected();b.render()}},animateAway:function(a){var b=this;$("#set_time_block").css("z-index",1).unwrap();$("#set_template_block").css("z-index",2);var c=[$("#starter_button"),$("#set_time_block"),$("#set_template_block")],d=0,e=$("#btn_overview").offset().top-this.$el.offset().top-50;$(c).each(function(){var f=$(this);d++;f.css({position:"absolute",top:f.position().top,left:f.position().left+parseInt(f.css("marginLeft")),width:f.width()}).animate({top:e,height:90},800,"easeInOutSine",function(){if(d==c.length){var e=$("#select-template-list");e.css({position:"absolute",zIndex:3,top:e.offset().top,left:e.offset().left,width:e.width()}).appendTo("#content");b.$el.fadeOut(500);e.animate({left:0,top:$("#btn_overview").offset().top,opacity:.2},1e3,"easeInOutSine",function(){$(this).remove();a&&a()})}})})},fadeOutError:function(){$("#bubble_msg").fadeOut("slow");$("#set_template_block").animate({opacity:1},{duration:200,queue:!1})},showError:function(){this.errorMsg=!0;var a=this;$("#bubble_msg").delay(250).fadeIn("slow",function(){$("#time-picker").click(function(){a.fadeOutError()});$("#set_template_block").click(function(){a.fadeOutError()})});window.setTimeout(function(){$("#set_template_block").animate({opacity:.5},{duration:200,queue:!1})},250)},hideError:function(){$("#bubble_msg").hide();this.errorMsg=!1},shakeADeal:function(){$("#time-picker").effect("shake",{times:2,queue:!1},50)},treasureDialog:function(){var a=this;require(["views/dialogs/treasure"],function(){a.readmore=new App.views.dialogs.Treasure({router:a.router});a.readmore.openDialog()})},startDeal:function(){if(this.starting)return;this.starting=!0;this.errorMsg&&this.hideError();var a=this;$("#btn_submit_start_deal").val("Planlægger...").addClass("disabled");var b={};b.shop_id=App.collections.shops.at(0).id;b.template_id=this.templateSelected;b.start=$("#deal_start_time").val();b.end=$("#deal_end_time").val();var c=new App.models.Deal;c.save(b,{success:function(b,d){if(d.success&&d.success=="true"){log("start response",c,b);App.collections.deals.add(c);a.animateAway(function(){a.activity.route=lang.urls[a.activity.activityName];a.router.navigate(lang.urls.overviewDeals+"/"+b.id,{trigger:!0});a.resetStarter(!0);a.router.trigger("dealEdited",{event:"deal_planned"})})}else{$("#btn_submit_start_deal").removeClass("disabled").val("Planlæg deal");a.starting=!1;if(d.error=="deal_already_planned"){a.shakeADeal();a.showError()}else a.router.showError("Der opstod en fejl","Din deal blev ikke startet<br />Fejlmeddelelse: "+d.error);log("start error",d)}},error:function(b,c){log(b,c);a.router.showError("Der opstod en fejl","Din deal blev ikke startet<br />Fejlmeddelelse: "+c.error)}})}})});define(["views/windows/window","views/dialogs/promtDialog"],function(){App.views.Activity=Backbone.View.extend({el:"#activities",animationTime:350,animationType:"slide",loaded:!1,ready:!1,locked:!1,queue:!1,init:function(){this.router=this.options.router;this.activityName||console.log("Jeg mangler et aktivitetsnavn"+this.cid);this.id="activity_"+this.activityName;_.bindAll(this,"render","activityChange","done","load","unload","clickedActivity","activityChange","activityUnloaded","confirmCallback","doQueue","closeAllWindows");$(this.el).append('<div id="'+this.id+'" class="activity"></div>');this.parentRoute=lang.urls[this.activityName];this.router.bind("activityChange",this.activityChange);this.router.bind("clickedActivity",this.clickedActivity);this.router.bind("activityUnloaded",this.activityUnloaded);this.router.bind("promtCallback:"+this.cid,this.confirmCallback);this.windows={}},clickedActivity:function(a){if(a.activity==this.activityName){if(a.hasOwnProperty("route")){this.oldRoute=this.route;this.route=a.route;a.hasOwnProperty("isRouted")||this.router.navigate(this.route,{trigger:!1})}if(a.hasOwnProperty("clicked")){this.hasOwnProperty("route")||(this.route=lang.urls[this.activityName]);a.hasOwnProperty("isRouted")||this.router.navigate(this.route,{trigger:!1})}a.hasOwnProperty("isParentRoute")&&this.closeAllWindows();a.hasOwnProperty("window")&&this.router.trigger("appendWindow",a);if(!a.hasOwnProperty("dontChange")){this.ready=!0;this.router.trigger("activityChange",{activity:this.activityName,animation:this.animationType,first:a.first})}}},activityChange:function(a){if(a.activity!=this.activityName){if(!this.loaded)return;this.unload(a.animation)}else if(a.activity==this.activityName&&a.first){this.ready&&this.load();this.ready=!1}},activityUnloaded:function(a){this.ready&&this.load();this.ready=!1},load:function(){var a=this;$("#btn_"+this.activityName).addClass("selected");var b=$("#activity_"+this.activityName);b.css("z-index",2);this.onBeforeLoad();switch(this.animationType){case"slide":b.css({left:-b.outerWidth()}).show(0,function(){a.onShow()}).delay(this.animationTime).animate({left:0},{duration:this.animationTime,easing:"easeOutExpo",complete:function(){a.done("load");$(this).addClass("ready")},queue:!1});break;case"slideDown":b.css({top:-b.outerHeight()}).show(0,function(){a.onShow()}).delay(this.animationTime).animate({top:0},{duration:this.animationTime*2,easing:"easeOutExpo",complete:function(){a.done("load");$(this).addClass("ready")},queue:!1});break;case"fade":b.fadeIn(this.animationTime,function(){a.onShow();a.done("load");$(this).addClass("ready")})}},done:function(a){switch(a){case"unload":this.router.trigger("activityUnloaded");this.loaded=!1;this.onHide();$("#activity_"+this.activityName).css("z-index","");break;case"load":this.loaded=!0;this.onLoad();$("#activity_"+this.activityName).css("z-index","");$("#activities").css({overflow:"visible"});this.router.trigger("unlock",{lock:"activity"})}},unload:function(a){this.router.trigger("lock",{lock:"activity"});$("#btn_"+this.activityName).removeClass("selected");var b=this;$("#activities").css({overflow:"hidden"});var c=$("#activity_"+this.activityName);c.css("z-index",1);switch(a){case"slide":$("#activity_"+this.activityName).removeClass("ready").animate({left:-c.outerWidth()},{duration:this.animationTime,easing:"easeInExpo",complete:function(){$(this).hide().css({left:0});b.done("unload")},queue:!1});break;case"slideDown":c.removeClass("ready").fadeOut(this.animationTime/2,function(){$(this).removeClass("ready");b.done("unload")});break;case"fade":c.removeClass("ready").fadeOut(this.animationTime,function(){$(this).removeClass("ready");b.done("unload")})}},onLoad:function(){},onBeforeLoad:function(){},onShow:function(){},onHide:function(){},confirmCallback:function(a){if(a.callbackCid==this.cid&&a.type=="confirmClose"&&a.windowName&&this.windows[a.windowName]){var b=this;switch(a.eventType){case"confirm":var c=this.windows[a.windowName];c.saveToModel({success:function(){c.closeWindow(function(){c.parent&&b.windows[c.parent]&&b.windows[c.parent].removeSelected();delete b.windows[a.windowName];b.doQueue()})}},!0);break;case"dont_save":var c=this.windows[a.windowName];c.closeWindow(function(){c.parent&&b.windows[c.parent]&&b.windows[c.parent].removeSelected();delete b.windows[a.windowName];b.doQueue()});break;case"cancel":this.queue=!1;this.router.trigger("setFocus",{activity:a.activity,windowCid:this.windows[a.windowName].cid})}}},appendWindow:function(a,b){var c=a;b.id&&(c=c+"-"+b.id);if(this.windows[c])return!1;if(b.parent&&b.clickId&&b.parent)if(this.windows[b.parent]){this.windows[b.parent].setLinkLoading(b.clickId);this.windows[b.parent].setSelected(b.clickId)}else var d=!0;var e="views/windows/"+a.toLowerCase(),f=this;require([e],function(){if(!f.windows[c]){b.activity=f;b.windowName=c;var e=new App.views.windows[a](b),g=!1;$.each(f.windows,function(a,b){if(!e.depth||b.depth&&b.depth>=e.depth){f.queue=e;f.closeWindow(a,!0,null,!0);g=!0}});if(!g){e.openWindow();d&&f.windows[e.parent]&&f.windows[e.parent].setSelected(b.clickId);f.windows[c]=e}}});return!0},closeAllWindows:function(){for(var a in this.windows)this.windows[a].depth>1&&this.closeWindow(this.windows[a],!1,!0)},closeWindow:function(a,b,c,d){var e=this,f,g=!0;if(b&&this.windows[a]){f=a;a=this.windows[f]}else $.each(this.windows,function(b,c){c==a&&(f=b)});if(a.confirmClose&&a.hasChanged())var h=new App.views.dialogs.PromtDialog({router:this.router,type:"confirmClose",callbackCid:this.cid,windowName:f});else a.closeWindow(function(){f&&e.windows[f]&&delete e.windows[f];!d&&a.parent&&e.windows[a.parent]&&e.windows[a.parent].removeSelected();if(c){e.router.navigate(e.parentRoute);e.route=e.parentRoute}e.doQueue()})},doQueue:function(){if(this.queue){var a=this,b=this.queue;b.openWindow();this.windows[b.options.windowName]=b;this.queue=!1}}})});define(["views/activities/activity"],function(){App.views.activities.Administration=App.views.Activity.extend({initialize:function(){this.activityName="administration";this.init();_.bindAll(this,"handleEvent");this.appendWindow("Administration",{router:this.router});this.router.bind("appendWindow",this.handleEvent)},handleEvent:function(a){switch(a.window){case"bruger":this.openUser();break;case"butik":this.openShop();break;default:return}},openShop:function(){var a="btn_admin_shops";this.appendWindow("ViewShop",{router:this.router,parent:"Administration",clickId:a})},openUser:function(){var a="btn_admin_user";this.appendWindow("AccountSettings",{router:this.router,parent:"Administration",clickId:a})}})});define(["views/activities/activity"],function(){App.views.activities.Overview=App.views.Activity.extend({activityName:"overview",initialize:function(){this.init();this.appendWindow("Overview",{router:this.router});_.bindAll(this,"handleEvent");this.router.bind("appendWindow",this.handleEvent)},handleEvent:function(a){switch(a.window){case"feedback":this.openFeedback();break;case"deals":var b=!1;a.hasOwnProperty("id")&&(b=a.id);this.openDeals(b);break;default:return}},openDeals:function(a){var b="btn_view_deals";a?this.windows.MyDeals?this.windows.MyDeals.showDeal(a,!0):this.appendWindow("MyDeals",{router:this.router,parent:"Overview",clickId:b,dealId:a}):this.windows.MyDeals?this.windows.MyDeals.showList():this.appendWindow("MyDeals",{router:this.router,parent:"Overview",clickId:b})},openFeedback:function(){var a="btn_view_feedback";this.appendWindow("Feedback",{router:this.router,parent:"Overview",clickId:a})}})});define(["text!templates/welcome.html","views/activities/activity"],function(a){App.views.activities.Welcome=App.views.Activity.extend({activityName:"welcome",animationType:"fade",activeText:!1,priority:0,initialize:function(){_.bindAll(this,"shopCreator");this.bubbleShown=!1;this.init();this.render()},render:function(){var b={};App.collections.shops.off("add",this.render);if(App.collections.shops.length==0){b.name="";b.text="text_add_shop";this.shopCreator();App.collections.shops.on("add",this.render)}else{b.name=App.collections.shops.at(0).get("name");b.text=""}$("#activity_welcome").html(_.template(a,{data:b}))},show:function(){$("#activity_welcome").fadeIn()},events:{"click #btn_add_shop":"openAddShop"},shopCreator:function(a,b){var c=this;require(["views/dialogs/addshop"],function(a){c.addShopBubble=new App.views.dialogs.AddShop({router:c.router});$("#activities").addClass("newbie")})},openAddShop:function(a){var b=$("#"+a.currentTarget.id),c=b.position().top-30,d=b.position().left+b.outerWidth(!0)/2;this.addShopBubble.openBubble(d,c)}})});define(["text!templates/dialogs/addshop.html","views/dialogs/dialog","async!http://maps.googleapis.com/maps/api/js?sensor=false"],function(a){App.views.dialogs.AddShop=Backbone.View.extend({el:"body",initialize:function(){_.bindAll(this,"saveShop","closeBubble","openBubble","success","doContinue");this.activity="welcome_greeting";this.router=this.options.router;this.render()},render:function(){var b=this;this.id="#welcome_add_shop";$(a).hide().appendTo("#"+this.activity);this.form=$("#consumer-signup");this.form.formValidate({tooltipOffset:15,rules:{shop_name:"required",shop_address:"required"}})},events:{"click #btn_confirm_shop":"confirmShop","keypress #shop_name, #shop_address":"doContinue","click #btn_reenter_shop":"doGoBack","click #continue_button":"doContinue"},openBubble:function(a,b){var c=this;a||(a=$(document).width()/2);b||(b=$(document).height()/2);$("#"+this.activity).css({height:$("#"+this.activity).height()});var d=$("#"+this.activity).outerHeight()-b,e=a-$(this.id).outerWidth()/2,c=this;$("#workspace").createMask();$(this.id).css({position:"absolute",bottom:d+"px",left:e+"px"}).fadeIn(400,function(){$("html").click(function(a){var b=$(a.target);!b.is(c.id)&&!b.parents().is(c.id)&&c.closeBubble()});$("#shop_name").focus();c.geocoderInit();c.bubbleShown=!0})},doNothing:function(a){a.stopPropagation()},closeBubble:function(){if(this.bubbleShown){this.bubbleShown=!1;$("html").off("click");$(this.id).off("click");$(this.id).fadeOut(800);$("#workspace").removeMask()}},success:function(a,b){log("result",a,b);if(b.success)App.collections.shops.add(a);else{log("else",a,b);thisClass.router.showError("Der opstod en fejl","Din butik blev ikke oprettet i systemet<br />Fejlmeddelelse: "+b.error)}},doContinue:function(a){var b=this;if((!a||!a.keyCode||a.keyCode==13)&&this.form.valid()){$("#add_shop_fields input:focus").blur();var c=function(a){if(a.length>0){$("#shop_lat").val(a[0].latitude);$("#shop_long").val(a[0].longitude);b.showConfirm()}};b.getAddress({term:$("#shop_address").val()},c,1)}},doGoBack:function(){$("#add_shop_fields").slideDown();$("#confirm_map").slideUp();$("#shop_address").focus()},showConfirm:function(){var a=$("#shop_lat").val(),b=$("#shop_long").val();if(a!=""&&b!=""){if(!this.map){var c={zoom:17
,streetViewControl:!1,zoomControl:!1,mapTypeControl:!1,mapTypeId:google.maps.MapTypeId.HYBRID};this.marker=new google.maps.Marker({draggable:!1});this.map=new google.maps.Map(document.getElementById("map_canvas"),c);this.marker.setMap(this.map)}var d=new google.maps.LatLng(a,b);this.marker.setPosition(d);this.map.setCenter(d);$("#confirm_shop_name").html($("#shop_name").val());$("#add_shop_fields").slideUp();$("#confirm_map").slideDown()}else{$("#shop_address").parents(".field").append("<div class='errorTip'>Kunne ikke finde den indtastede adresse</div>");$("#shop_address").focus()}},confirmShop:function(a){var b=$("#shop_lat").val(),c=$("#shop_long").val(),d=$("#shop_name").val(),e=$("#shop_address").val();if(!b||!c)return alert("ingen koordinater");if(!d)return alert("Indtast navnet på butikken");this.saveShop(d,e,b,c);this.closeBubble()},saveShop:function(a,b,c,d){var e=new App.models.Shop,f=this;e.save({lat:c,"long":d,name:a,address:b},{success:this.success,error:function(a,b){log("saveShop error",a,b);f.router.showError("Der opstod en fejl","Din butik blev ikke oprettet i systemet<br />Fejlmeddelelse: "+b.error)}})},getAddress:function(a,b,c){!!this.geocoder;c||(c=3);var d=a.term+" , Denmark";this.geocoder.geocode({address:d},function(a,d){d!=google.maps.GeocoderStatus.OK;var e=0;b($.map(a,function(a){e++;if(e>c)return;return{label:a.formatted_address,value:a.formatted_address,postal_code:a.postal_code,latitude:a.geometry.location.lat(),longitude:a.geometry.location.lng()}}))})},geocoderInit:function(){var a=this;google||setTimeout(a.geocoderInit,300);this.geocoder||(this.geocoder=new google.maps.Geocoder);$("#shop_address").autocomplete({minLength:4,appendTo:"#welcome_add_shop",source:function(b,c){a.getAddress(b,c)},select:function(b,c){log("clicked?",b,c);$("#shop_lat").val(c.item.latitude);$("#shop_long").val(c.item.longitude);$("#shop_address").val(c.item.label);a.doContinue()}})}})});define(["views/activities/activity","views/startdeal"],function(){App.views.activities.StartDeals=App.views.Activity.extend({el:"#activities",animationType:"slideDown",menu_icon:"#btn_startdeals",initialize:function(){this.activityName="startdeals";_.bindAll(this,"templateFetched","handleNotReady","deactivateButton","activateButton","shopFetched");this.init();this.collection=App.collections.templates;App.views.startDeal=new App.views.StartDeal({router:this.router,activity:this});this.shopFetched("add",App.collections.shops);this.templateFetched("add",App.collections.templates);App.collections.templates.bind("change",this.templateFetched);App.collections.templates.bind("add",this.templateFetched);App.collections.templates.bind("reset",this.templateFetched);App.collections.shops.bind("change",this.shopFetched);App.collections.shops.bind("reset",this.shopFetched);App.collections.shops.bind("add",this.shopFetched)},deactivateButton:function(a){var b=$(this.menu_icon);b.hasClass("disabled")||b.addClass("disabled");b.attr("title",a);if(!this.tooltip){b.tooltip({predelay:200,delay:200,tipClass:"menu-tooltip",offset:[-15,0],onBeforeShow:function(a,b){if(this.getTrigger().attr("title")!=""){this.getTip().text(this.getTrigger().attr("title"));this.getTrigger().removeAttr("title")}}});this.tooltip=b.data("tooltip")}},closeAllWindows:function(){App.views.startDeal.collapse(!0)},activateButton:function(){var a=$(this.menu_icon);a.hasClass("disabled")&&a.removeClass("disabled");a.removeAttr("title");if(this.tooltip){a.unbind("mouseover").unbind("mouseout");this.tooltip.getTip()&&this.tooltip.getTip().remove();a.data("tooltip",null);this.tooltip=null}},handleNotReady:function(){var a="";this.templateIsApproved||(a="En af dine skabeloner skal godkendes før du kan starte deal");this.templateIsFetched||(a="Du skal oprette en skabelon før du kan starte deals");this.shopIsApproved||(a="Din shop venter på at blive godkendt, så du kan ikke starte deals endnu");a?this.deactivateButton(a):this.activateButton()},shopFetched:function(a,b){if(a&&App.collections.shops.at(0)){var c=App.collections.shops.at(0);this.shopIsFetched=!0;if(c.get("approved")=="approved"){this.shop_id=c.get("id");this.shopIsApproved=!0}else this.shopIsApproved=!1}this.handleNotReady()},templateFetched:function(a,b){if(a&&this.collection.length>0){this.templateIsFetched=!0;var c=this.collection.filter(function(a){return a.get("approved")=="approved"});if(c.length>0){this.templateIsApproved=!0;this.templates=c;this.router.trigger("templatesUpdated",c)}else{this.templateIsApproved=!1;this.templates=null}}else this.templateIsFetched=!1;this.handleNotReady()},onShow:function(){App.views.startDeal.setVerticalAlign()}})});define(["text!templates/component/templateSelector.html"],function(a){App.views.components.TemplateSelectorView=Backbone.View.extend({el:"#content",initialize:function(){_.bindAll(this,"handleClick","updateContent","expandList","collapseList","setSelected","resetSelected");this.componentId="#cmp-"+this.cid;this.$collapsed;this.$expanded;this.router=this.options.router;this.created=!1;this.expanded=this.options.expandOnCreate?this.options.expandOnCreate:!1;this.height=this.options.height?this.options.height:320;this.width=this.options.width?this.options.width:320;this.appendTo=this.options.appendTo?this.options.appendTo:this.el;this.parent=this.options.parent?this.options.parent:this.el;this.options.onCreated&&(this.onCreated=this.options.onCreated);this.options.onExpand&&(this.onExpand=this.options.onExpand);this.options.onCollapse&&(this.onCollapse=this.options.onCollapse);this.collection=App.collections.templates;this.templates=this.collection.getApproved();App.collections.templates.bind("change",this.updateContent);App.collections.templates.bind("add",this.updateContent);App.collections.templates.bind("reset",this.updateContent);this.render()},render:function(){var b=this,c=_.template(a,{data:this});$(this.appendTo).html(c);this.$el=$(this.componentId);this.$collapsed=$("#templateSelector-collapsed");this.$expanded=$("#templateSelector-expanded");this.expanded&&setTimeout(function(){b.expandedHeight=b.$expanded.getHiddenDimensions(!0).outerHeight;b.expandedHeight=b.expandedHeight>b.height?b.height:b.expandedHeight;b.$expanded.height(b.expandedHeight);b.onCreated&&b.onCreated()},100);this.created=!0},events:{"click #templateSelector-expanded .list-item":"handleClick","click #templateSelector-collapsed .list-item":"expandList","click #btn_expand_template_list":"expandList"},handleClick:function(a){var b=a.currentTarget.id;this.setSelected(b)},updateContent:function(a){this.templates=this.collection.getApproved();this.render()},expandList:function(){var a=this;this.$collapsed.hide();this.$expanded.slideDown("slow");a.onExpand&&a.onExpand();a.expanded=!0},collapseList:function(){if(this.expanded){var a=this;if($("#templateSelector-"+this.cid).is(":visible"))this.$expanded.slideUp(function(){a.$collapsed.fadeIn("fast");a.onCollapse&&a.onCollapse()});else{this.$expanded.hide();this.$collapsed.show();this.onCollapse&&this.onCollapse()}this.expanded=!1}},setSelected:function(a){this.selected=this.collection.get(a).toJSON();var b=$($("#"+a).outerHTML()).removeClass("selected");this.$expanded.children(".list-item.selected").removeClass("selected");$("#"+a).addClass("selected");this.$collapsed.html(b);this.collapseList();this.collapsedHeight=this.$collapsed.getHiddenDimensions(!0).outerHeight;this.router.trigger("templateSelected",{templateId:a,parent:this.parent})},resetSelected:function(){if(this.selected){this.selected=null;this.$expanded.children(".list-item.selected").removeClass("selected");this.expandList()}}})});define(["views/activities/activity"],function(){App.views.activities.Templates=App.views.Activity.extend({initialize:function(){this.activityName="templates";this.init();_.bindAll(this,"openAddTemplate","handleEvent","openViewTemplate");this.appendWindow("MyTemplates",{router:this.router});this.router.bind("appendWindow",this.handleEvent)},handleEvent:function(a){switch(a.window){case"viewTemplate":this.openViewTemplate(a.id);break;case"addTemplate":this.openAddTemplate();break;default:return}},openAddTemplate:function(){this.appendWindow("AddTemplate",{router:this.router,parent:"MyTemplates"})},openViewTemplate:function(a){var b="template-"+a,c=App.collections.templates.get(a);if(!c){this.router.navigate(lang.urls.templates);return}this.appendWindow("ViewTemplate",{router:this.router,id:a,model:c,parent:"MyTemplates",clickId:b})}})});